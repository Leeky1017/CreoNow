# Knowledge Graph Specification Delta

## Change: s3-state-extraction

### Requirement: 章节完成时必须提取角色状态变化并回写知识图谱 [ADDED]

系统在章节完成事件触发后，必须调用状态提取能力获取角色状态变化，并将可匹配实体的最新状态回写到 `lastSeenState`。提取失败不得静默。

#### Scenario: S3-STE-S1 章节完成后提取并更新匹配角色状态 [ADDED]

- **假设** 章节正文包含角色状态变化描述，且 KG 中存在对应角色实体
- **当** 用户完成章节并触发状态提取
- **则** 系统必须提取每个匹配角色的最新状态并更新实体 `lastSeenState`
- **并且** 更新结果可被后续实体查询立即读取

#### Scenario: S3-STE-S2 提取结果包含未知角色时跳过并记录告警 [ADDED]

- **假设** 提取结果中包含 KG 不存在的角色名
- **当** 系统执行状态回写
- **则** 未匹配角色必须被跳过，不得创建隐式实体
- **并且** 系统必须记录包含角色名与章节上下文的结构化 warning

#### Scenario: S3-STE-S3 提取失败时章节完成流程保持可用且失败可观测 [ADDED]

- **假设** LLM 调用超时或返回无法通过 schema 校验的数据
- **当** 状态提取在章节完成流程中执行
- **则** 章节完成主流程必须继续，不得因提取失败中断
- **并且** 系统必须返回结构化降级信号（含错误码与日志字段），禁止静默失败

## Out of Scope

- 新增或重构知识图谱实体/关系 schema
- 摘要技能生成与摘要注入逻辑
- 章节编辑 UI 交互和渲染层布局调整

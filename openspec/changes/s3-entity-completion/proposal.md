# 提案：s3-entity-completion

## 背景

当前编辑器缺少实体补全能力，用户在编写角色、地点、设定名词时需要手动回忆与输入，容易出现命名不一致和上下文漂移。Sprint 3 需要在 Editor 层补齐实体补全交互，让实体引用更快、更一致，并降低后续 AI 上下文冲突。

## 变更内容

- 在 Editor 中新增实体补全面板：基于输入前缀实时展示候选实体。
- 支持键盘导航与回车确认，插入规范化实体文本（保留用户编辑流畅度）。
- 约束无结果与服务不可用路径：明确提示，不做静默吞没。

## 受影响模块

- Editor（`apps/desktop/renderer/src/features/editor/`）— 新增实体补全触发、面板状态与插入行为。
- Store（`apps/desktop/renderer/src/stores/editorStore.tsx`）— 增加实体补全会话状态。
- IPC（实体查询通道）— 复用既有实体检索能力，不改变通道契约。

## 依赖关系

- 上游依赖：无强依赖（基于现有实体查询契约即可启动）。
- 横向关注：与 Search/RAG 实体命名语义保持一致，避免编辑器与检索层词汇漂移。

## 依赖同步检查（Dependency Sync Check）

- 核对输入：
  - `openspec/specs/editor/spec.md` 现有编辑器交互约束；
  - 现有实体查询 IPC 契约与返回字段。
- 核对项：
  - 是否仅新增补全交互，不破坏现有输入与保存路径；
  - 候选项渲染与插入是否可被测试稳定覆盖；
  - 无结果/异常路径是否显式可见。
- 结论：`NO_DRIFT`。

## 踩坑提醒（防复发）

- 补全面板显示与隐藏条件必须可预测，避免“闪烁/卡住”导致误输入。
- 插入实体后光标位置需要稳定，禁止打断用户连续输入。
- 命名规范与实体展示字段必须统一，避免编辑器端自造字段风格。

## 代码问题审计重点

- 来自 `docs/代码问题/虚假测试覆盖率.md`：补全交互测试必须覆盖键盘导航、无结果、异常路径，禁止仅测渲染成功。
- 来自 `docs/代码问题/虚假测试覆盖率.md`：断言应验证“插入结果 + 光标位置 + 状态清理”，而非只验证列表出现。
- 来自 `docs/代码问题/风格漂移与项目约定偏离.md`：状态命名、事件命名、错误提示文案遵循现有 Editor/Store 约定。
- 来自 `docs/代码问题/风格漂移与项目约定偏离.md`：新增文件布局应与现有 editor feature 组织一致，避免平行目录风格漂移。

## 防治标签

- `FAKETEST` `DRIFT`

## 不做什么

- 不在本 change 内新增富文本节点类型。
- 不改动 AI 面板协议与消息编排。
- 不扩展知识图谱 schema。

## 审阅状态

- Owner 审阅：`PENDING`

import{j as n}from"./jsx-runtime-BLchON5X.js";import{R as S}from"./index-DDi9LDaq.js";import{B as p}from"./Button-B9XLIlTV.js";import"./Input-BR80orUP.js";import{T as se}from"./Textarea-C3DI-yW7.js";import{C as R}from"./Card-D2dqmnxE.js";import"./ListItem-CyD6nTsv.js";import{T as d}from"./Text-CW-Kyc9R.js";import"./Heading-BzOyC2Oj.js";import"./Dialog-DJV5UiAm.js";import"./Popover-BMinsKFS.js";import"./Select-DBTPtHXT.js";import"./Checkbox-Ddw3urWg.js";import"./Tabs-DmRrGnuH.js";import"./Badge-0PIbcpDO.js";import"./Avatar-CFHo7YSR.js";import"./Spinner-BG3j59Um.js";import"./Skeleton-CwzwMFJo.js";import"./Tooltip-Ca9CUhYJ.js";import"./Toast-HPSiDIc2.js";import"./Accordion-F8I8yqG1.js";import"./Radio-DYZtN_dz.js";import{u as r}from"./aiStore-C1VK9pLi.js";import{u as C}from"./contextStore-Cf33-zum.js";import{u as b}from"./editorStore-ByocGlaq.js";import{u as re}from"./projectStore-wjKW615C.js";import{C as oe}from"./ContextViewer-lK2KqFKr.js";import{D as ie}from"./DiffView-B8aluX7v.js";import{S as le}from"./SkillPicker-B04EGmsV.js";function ae(t){return t.replaceAll(`\r
`,`
`)}function D(t){return t.length===0?[]:ae(t).split(`
`)}function ce(t){if(t.oldText===t.newText)return"";const s=t.oldLabel??"old",o=t.newLabel??"new",a=D(t.oldText),c=D(t.newText),i=[];i.push(`--- ${s}`),i.push(`+++ ${o}`),i.push(`@@ -1,${a.length} +1,${c.length} @@`);for(const u of a)i.push(`-${u}`);for(const u of c)i.push(`+${u}`);return`${i.join(`
`)}
`}function h(t,s){return{code:t,message:s}}function V(t){let s=2166136261;for(let o=0;o<t.length;o+=1)s^=t.charCodeAt(o),s=Math.imul(s,16777619);return(s>>>0).toString(16).padStart(8,"0")}function $(t,s){try{return{ok:!0,data:t.state.doc.textBetween(s.from,s.to,`
`)}}catch{return{ok:!1,error:h("CONFLICT","Selection range is no longer valid; regenerate the diff and retry")}}}function de(t){const s={from:t.state.selection.from,to:t.state.selection.to};if(s.from===s.to)return{ok:!1,error:h("INVALID_ARGUMENT","Selection is empty")};if(s.from>s.to)return{ok:!1,error:h("INVALID_ARGUMENT","Invalid selection range")};const o=$(t,s);if(!o.ok)return o;const a=o.data,c={range:s,selectionTextHash:V(a)};return{ok:!0,data:{selectionText:a,selectionRef:c}}}function ue(t){const s=t.selectionRef.range;if(s.from===s.to)return{ok:!1,error:h("INVALID_ARGUMENT","Selection is empty")};const o=$(t.editor,s);if(!o.ok)return o;const a=o.data;if(V(a)!==t.selectionRef.selectionTextHash)return{ok:!1,error:h("CONFLICT","Selection content changed; regenerate the diff and retry")};try{const i=t.editor.state.tr.insertText(t.replacementText,s.from,s.to);t.editor.view.dispatch(i)}catch{return{ok:!1,error:h("INTERNAL","Failed to apply selection replacement")}}return{ok:!0,data:{applied:!0}}}const M="ai:skill:stream";function pe(t){return typeof t=="object"&&t!==null}function me(t){return!(!pe(t)||typeof t.type!="string"||typeof t.runId!="string"||typeof t.ts!="number")}function fe(){const t=r(s=>s.onStreamEvent);S.useEffect(()=>{function s(o){const c=o.detail;me(c)&&t(c)}return window.addEventListener(M,s),()=>window.removeEventListener(M,s)},[t])}function L(t){return t==="running"||t==="streaming"}function he(){fe();const t=r(e=>e.status),s=r(e=>e.stream),o=r(e=>e.selectedSkillId),a=r(e=>e.skills),c=r(e=>e.skillsStatus),i=r(e=>e.skillsLastError),u=r(e=>e.input),g=r(e=>e.outputText),v=r(e=>e.lastRunId),T=r(e=>e.lastError),E=r(e=>e.selectionRef),N=r(e=>e.selectionText),l=r(e=>e.proposal),y=r(e=>e.applyStatus),U=r(e=>e.setInput),F=r(e=>e.setStream),H=r(e=>e.setSelectedSkillId),z=r(e=>e.refreshSkills),B=r(e=>e.clearError),O=r(e=>e.setError),k=r(e=>e.setSelectionSnapshot),j=r(e=>e.setProposal),G=r(e=>e.persistAiApply),J=r(e=>e.logAiApplyConflict),W=r(e=>e.run),K=r(e=>e.cancel),m=b(e=>e.editor),f=b(e=>e.projectId),x=b(e=>e.documentId),w=re(e=>e.current),P=C(e=>e.viewerOpen),Y=C(e=>e.toggleViewer),q=C(e=>e.refresh),[Q,A]=S.useState(!1);S.useEffect(()=>{z()},[z]),S.useEffect(()=>{t==="idle"&&(l||!v||g.trim().length===0||!E||N.length===0||j({runId:v,selectionRef:E,selectionText:N,replacementText:g}))},[v,g,l,E,N,j,t]);const X=l?ce({oldText:l.selectionText,newText:l.replacementText}):"",Z=!!m&&!!l&&!!f&&!!x&&y!=="applying";async function ee(){if(j(null),O(null),m){const I=de(m);I.ok?k(I.data):k(null)}else k(null);const e=await q({projectId:w?.projectId??f??null,skillId:o??null,immediateInput:u});await W({inputOverride:e.promptText,context:{projectId:w?.projectId??f??void 0,documentId:x??void 0},promptDiagnostics:e.hashes})}function te(){j(null),k(null)}async function ne(){if(!m||!l||!f||!x)return;const e=ue({editor:m,selectionRef:l.selectionRef,replacementText:l.replacementText});if(!e.ok){O(e.error),e.error.code==="CONFLICT"&&J({documentId:x,runId:l.runId});return}const I=JSON.stringify(m.getJSON());await G({projectId:f,documentId:x,contentJson:I,runId:l.runId})}const _=a.find(e=>e.id===o)?.name??o;return n.jsxs("section",{"data-testid":"ai-panel",className:"flex flex-col gap-3 p-3 min-h-0 relative",children:[n.jsxs("header",{className:"flex items-center gap-2",children:[n.jsx(d,{size:"small",color:"muted",children:"AI"}),n.jsxs("div",{className:"ml-auto flex items-center gap-2",children:[n.jsx(p,{"data-testid":"ai-context-toggle",variant:"ghost",size:"sm",onClick:()=>{Y({projectId:w?.projectId??f??null,skillId:o??null,immediateInput:u})},className:P?"bg-[var(--color-bg-base)]":"",children:"Context"}),n.jsx(p,{"data-testid":"ai-skills-toggle",variant:"ghost",size:"sm",onClick:()=>A(e=>!e),className:"max-w-[220px] overflow-hidden text-ellipsis whitespace-nowrap",title:_,children:c==="loading"?"Skillsâ€¦":_}),n.jsx(d,{"data-testid":"ai-status",size:"tiny",color:"muted",children:t})]})]}),n.jsx(le,{open:Q,items:a,selectedSkillId:o,onOpenChange:A,onSelectSkillId:e=>{H(e),A(!1)}}),y==="applied"?n.jsx(d,{"data-testid":"ai-apply-status",size:"small",color:"muted",children:"Applied & saved"}):null,i?n.jsxs(R,{noPadding:!0,className:"p-2.5",children:[n.jsx(d,{size:"code",color:"muted",children:i.code}),n.jsx(d,{size:"small",color:"muted",className:"mt-1.5 block",children:i.message})]}):null,T?n.jsxs(R,{noPadding:!0,className:"p-2.5",children:[n.jsxs("div",{className:"flex gap-2 items-center",children:[n.jsx(d,{"data-testid":"ai-error-code",size:"code",color:"muted",children:T.code}),n.jsx(p,{variant:"ghost",size:"sm",onClick:B,className:"ml-auto",children:"Dismiss"})]}),n.jsx(d,{size:"small",color:"muted",className:"mt-1.5 block",children:T.message})]}):null,n.jsxs("label",{className:"flex items-center gap-2",children:[n.jsx("input",{"data-testid":"ai-stream-toggle",type:"checkbox",checked:s,onChange:e=>F(e.target.checked),disabled:L(t),className:"h-4 w-4 accent-[var(--color-fg-default)]"}),n.jsx(d,{size:"small",color:"muted",children:"Stream"})]}),n.jsx(se,{"data-testid":"ai-input",value:u,onChange:e=>U(e.target.value),placeholder:"Type E2E_DELAY / E2E_TIMEOUT / E2E_UPSTREAM_ERROR markers to drive fake server.",fullWidth:!0,className:"min-h-[92px]"}),n.jsxs("div",{className:"flex gap-2",children:[n.jsx(p,{"data-testid":"ai-run",variant:"secondary",size:"md",onClick:()=>{ee()},disabled:L(t),className:"flex-1",children:"Run"}),n.jsx(p,{"data-testid":"ai-cancel",variant:"ghost",size:"md",onClick:()=>{K()},disabled:!L(t),children:"Cancel"})]}),P?n.jsx(oe,{}):null,n.jsx(R,{noPadding:!0,className:"p-2.5 min-h-[120px] flex-1 overflow-auto",children:n.jsx("pre",{"data-testid":"ai-output",className:"m-0 whitespace-pre-wrap break-words text-xs leading-[18px] text-[var(--color-fg-base)] font-[var(--font-family-mono)]",children:g})}),l?n.jsxs(n.Fragment,{children:[n.jsx(ie,{diffText:X}),n.jsxs("div",{className:"flex gap-2",children:[n.jsx(p,{"data-testid":"ai-apply",variant:"secondary",size:"md",onClick:()=>{ne()},disabled:!Z,className:"flex-1",children:"Apply"}),n.jsx(p,{"data-testid":"ai-reject",variant:"ghost",size:"md",onClick:te,disabled:y==="applying",children:"Reject"})]})]}):null]})}he.__docgenInfo={description:`AiPanel is the minimal UI surface for P0 AI runtime.

Why: Windows E2E must be able to drive stream/cancel/timeout/upstream-error
without depending on editor integrations.`,methods:[],displayName:"AiPanel"};export{he as A};

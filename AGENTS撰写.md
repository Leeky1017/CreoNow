# 指令：彻底重构 [AGENTS.md](http://AGENTS.md)（给 CodeX）



**这不是一份 [AGENTS.md](http://AGENTS.md) 的草稿。** 这是一份元层指令——告诉你**怎么思考**和**怎么执行**这次重构。你的产出是一份全新的 [`AGENTS.md`](http://AGENTS.md)，不是对本文档的复制。


## §零、你的任务

你要**彻底重构** CreoNow 项目的 [`AGENTS.md`](http://AGENTS.md)。

- **不是**整理、润色、重新排版
- **是**从零重新思考这份文件的信息架构，然后重写

当前版本约 13 个章节、29 条禁令，存在严重的结构性问题（见 §二）。你的产出必须解决这些问题，同时保留所有必要的约束力。

**交付标准**：产出必须通过 §六 的质量检查清单。未通过即为失败。

---

## §一、三个前提：在动手之前你必须理解的事

### 1.1 [AGENTS.md](http://AGENTS.md) 是什么

[AGENTS.md](http://AGENTS.md) 不是文档、不是手册、不是 README。它是**宪法**——一个约束系统。

它的读者不是人类开发者，而是 AI Agent。Agent 的认知模式与人类不同：

- Agent 没有「常识」兜底，它只信任明文写出的规则
- Agent 的上下文窗口有限，冗余信息直接降低关键规则的权重
- Agent 倾向于逐条执行，而非理解「精神」后灵活应用
- **重复出现的规则不会被 Agent 理解为「强调」，而是被理解为「两条不同的规则」，导致冲突或冗余解析**

因此：这份文件的首要设计目标不是「全面」，而是**无歧义、无冗余、可执行**。

### 1.2 Agent 怎么使用这份文件

典型的 Agent 阅读链：

```
1. 通读 AGENTS.md（建立约束框架）
2. 阅读 project.md（建立项目上下文）
3. 阅读 spec.md（建立任务上下文）
4. 开始执行
5. 遇到不确定时，回查 AGENTS.md 的特定章节
```

这意味着 [AGENTS.md](http://AGENTS.md) 需要支持两种阅读模式：

- **首次通读**：快速建立完整的约束心智模型（渐进式，从原则到细节）
- **按需回查**：精确定位到某条规则（结构清晰，互不交叉）

### 1.3 什么样的写法最有效

你在重构时，需要运用以下语言策略：

- **词汇精度**：每个术语只有一个含义，每个含义只用一个术语。例如「spec」就是 spec，不要在某处叫「规范」、另一处叫「行为定义」、再一处叫「契约」
- **句法控制力**：规则句必须是祈使句或条件句（「你必须 X」「当 Y 时，你必须 Z」），不要用叙述句（「X 是很重要的」「我们倡导 Y」）
- **结构化表达**：同类信息用同一种格式呈现。如果五条原则中三条用了 ✅/❌ 示例，另外两条没有，Agent 会困惑
- **抽象-具象切换**：先给原则（抽象），再给示例（具象），再给禁令（边界）。不要把三者混在一起
- **精炼度**：能用一句话说清楚的，不要用三句。能用结构表达的（表格、列表），不要用散文。每一个多余的句子都在稀释关键规则的注意力权重

---

## §二、当前版本的六个结构性问题

你必须在重构中解决以下所有问题。如果你的产出仍然存在其中任何一个，就是失败。

### 问题 1：原则与禁令大面积重复

§三（不可违反的规则）和 §四/§五（禁止行为清单）之间存在系统性重复。例如：

- §三 3.1 说「禁止跳过 spec 直接写代码」→ §四/§五 第 1 条重复
- §三 3.2 说「禁止先写实现再补测试」→ §四/§五 第 9 条重复
- §三 3.4 说「禁止手动合并」→ §四/§五 第 19 条重复
- §三 3.5 说「禁止直接修改主 spec」→ §四/§五 第 2 条重复

**根因**：「原则」+「禁令清单」双轨并存，但两者说的是同一件事的正面表述和反面表述。Agent 会把它们当作不同的规则分别执行。

### 问题 2：禁令数量失控

29 条禁令。对 Agent 而言，29 条平铺的硬禁令意味着每一条的权重都是 1/29。真正关键的规则（如 Spec-First）和技术细节（如 pnpm --frozen-lockfile）被赋予了相同的注意力权重。

**根因**：没有层级。所有规则都是「禁止」，没有区分「原则级」和「操作级」。

### 问题 3：信息架构不支持渐进式认知

当前结构是平铺的 13 个章节（或新版 8 个章节）。Agent 第一次读完后，脑中没有一个清晰的层次模型，只有一堆平行的规则碎片。

**根因**：缺乏认知脚手架。没有从「原则 → 流程 → 细节」的递进结构。

### 问题 4：禁令清单是原则的冗余展开，不是独立价值

如果删掉禁令清单，只保留 §三 的原则，Agent 仍然能推导出绝大部分禁令。禁令清单的存在只是因为不信任 Agent 能从原则推导，但代价是文件体积翻倍、注意力被分散。

**根因**：写作者没有区分「原则」和「原则的推论」。

### 问题 5：工作流程和原则交叉嵌套

§五/§六 的工作流程中嵌入了规则（如「Issue 必须为 OPEN 状态」「必须从 origin/main 创建分支」），这些规则和 §三/§四 的禁令重复，但又分散在不同位置。

**根因**：没有明确区分「约束」和「过程」。约束应该集中声明，过程中引用约束而非重复约束。

### 问题 6：外部化不彻底

新版已经将测试要求、代码原则、异常处理等外部化到 `docs/references/`，但 §七 的参考文档表和阅读链中仍然存在冗余指引。同时，被外部化的内容在新版主体中仍有残留表述。

**根因**：外部化不彻底。应该只保留一个指针，不保留任何摘要。

---

## §三、重构的七条设计原则

你在重构时必须遵循这些设计原则：

1. **原则优先，推论后置**：先建立少量高层原则（≤7 条），然后将所有禁令作为原则的推论组织，而非独立清单
2. **零冗余**：任何信息只出现一次。如果某条规则在原则中已经说清楚了，就不要在禁令中重复。如果需要强调，用「推导自 P*」标注
3. **渐进式认知**：文件结构必须支持从抽象到具象的阅读路径（原则 → 架构 → 流程 → 参考）
4. **单一信息密度**：每个章节只做一件事。原则章节不夹带流程，流程章节不夹带约束
5. **可回查性**：每条规则有唯一编号（如 P1、P2），禁令和流程中的引用使用编号而非重复内容
6. **外部化彻底**：凡是不影响 Agent 首次建立约束心智模型的细节，全部外部化到 `docs/references/`，主文件只保留指针
7. **格式一致性**：所有原则使用相同的呈现格式（一句话声明 + 解释 + ✅/❌ 示例）。不允许某些原则有示例而其他没有

---

## §四、推荐的目标结构

以下是建议的章节结构。你可以在此基础上微调，但层级逻辑不可改变。

```
§0  开头（一句话定位 + 违反后果声明 + 索引表）
§1  阅读链与文档导航（Agent 必读顺序 + 文档速查表）
§2  核心原则（P1–P7，每条：一句话声明 + 解释 + ✅/❌ 示例）
§3  架构总览（四层 + 12 模块 Spec 路径表，纯事实，不夹带规则）
§4  三体系协作（OpenSpec / Rulebook / GitHub 职责表，纯结构说明）
§5  工作流程（接任务 → 开发 → 合并 → 收口，骨架 + 指向 delivery-skill.md 的指针）
§6  补充禁令（≤5 条：能从原则推导但历史上反复出错的操作级提醒，每条标注「推导自 Px」）
§7  参考文档索引（纯指针表，一行一个文件，不含摘要）
```

**关键约束**：

- §2 是文件的核心，占比应最大（约 40%–50%）
- §6 的禁令数量不得超过 5 条（如果超过，说明你的原则写得不够好，需要回去改 §2）
- 整份文件总长度应比当前版本**显著缩短**（目标：减少 30%–50%）

---

## §五、预置内容：7 条核心原则

以下 7 条核心原则已经过提炼，覆盖了当前版本的全部 29 条禁令。**你不需要重新抽象这些原则**，直接使用它们作为 §2 的骨架。

你需要做的是：按照 §三 的设计原则（统一格式、✅/❌ 示例、精炼措辞），将这些原则写成 [AGENTS.md](http://AGENTS.md) 中的正式版本。

### 5.1 七条原则与覆盖映射

| 原则 | 一句话声明 | 覆盖的当前禁令编号 |
| --- | --- | --- |
| **P1. Spec-First** | 你不得在没有 spec 的情况下写任何实现代码 | 1, 2, 3, 4, 5, 6, 7, 8 |
| **P2. Test-First** | 你不得在没有失败测试的情况下写任何实现代码 | 9, 10, 11, 12, 13 |
| **P3. Evidence** | 你做的每一件事都必须有可追溯的记录，没有记录等于没有发生 | 16, 17, 27 |
| **P4. Gates** | PR 必须通过所有 required checks 且使用 auto-merge，没有例外 | 18, 19, 20, 21 |
| **P5. Change Protocol** | 主 spec 代表系统当前真实状态，所有变更必须走 Proposal → Apply → Archive | 2, 3, 4, 5, 6, 7, 8, 22, 23 |
| **P6. Deterministic & Isolated** | 你的所有操作必须是确定性的、可复现的、与外部环境隔离的 | 14, 15, 25, 26 |
| **P7. Escalate, Don't Improvise** | 遇到任何不确定的情况，停下来、记录、通知 Owner，不得根据猜测继续执行 | 24 + 所有原则的兜底 |

### 5.2 每条原则的展开要点

以下是每条原则需要包含的核心内容。你在写入 [AGENTS.md](http://AGENTS.md) 时，需要按照统一格式（一句话声明 → 解释 → 规则要点 → ✅/❌ 示例）重新组织。

**P1. Spec-First**

- Spec 是 Owner 和 Agent 之间的合同。没有合同就没有施工
- 收到任务后，第一步永远是阅读 spec
- spec 不存在或不完整 → 通知 Owner → 等确认 → 才能动手
- 开发中发现 spec 遗漏 → 补 delta spec → 通知 Owner → 等确认 → 再实现
- 超出 spec 范围的行为需要 Owner 确认

**P2. Test-First**

- 严格 Red → Green → Refactor 循环
- Spec 中每个 Scenario 必须被翻译为至少一个测试用例，零遗漏
- 测试必须验证行为，不得验证实现细节
- 测试必须独立、确定、有意义

**P3. Evidence**

- 每个任务必须有 RUN_LOG
- 关键命令的输入输出必须记录
- CI 失败和修复过程必须记录
- 遇到阻塞必须记录并通知，不得静默放弃
- PR 链接必须回填真实值，不得留占位符

**P4. Gates**

- 三个 required checks：`ci`、`openspec-log-guard`、`merge-serial`
- 所有 PR 必须启用 auto-merge，禁止手动合并
- CI 不绿就不合并
- 交付规则文档与 branch protection 必须一致，不一致时阻断并升级
- 交付完成的标志是代码已合并到 `main`，不是在 `task/*` 分支上提交了代码

**P5. Change Protocol**

- 主 spec 代表系统当前真实状态，禁止直接修改
- 所有变更走 Proposal → Apply → Archive
- Delta Spec 使用 `[ADDED]`/`[MODIFIED]`/`[REMOVED]` 标记
- 每个 change 的 [`tasks.md`](http://tasks.md) 按固定 TDD 章节顺序撰写
- TDD Mapping 未建立、Red 失败证据未记录时，禁止进入实现
- PR 合并后才能将 delta spec 归档到主 spec
- ≥2 个活跃 change 时必须维护 `EXECUTION_[ORDER.md](http://ORDER.md)`
- 存在上游依赖的 change，进入 Red 前必须完成 Dependency Sync Check

**P6. Deterministic & Isolated**

- 测试不得依赖真实时间、随机数、网络请求（fake timer、固定种子、mock）
- 集成测试和 E2E 中 LLM 必须 mock，不得消耗真实 API 额度
- 每个任务在独立 worktree 中工作
- 分支必须从最新 `origin/main` 创建
- `pnpm install` 必须使用 `--frozen-lockfile`

**P7. Escalate, Don't Improvise**

- 所有原则的兜底原则：当你不确定 P1–P6 怎么应用时，执行 P7
- Spec 不存在或矛盾 → 停下来，通知 Owner
- 任务超出 spec 范围 → 停下来，通知 Owner
- 上游依赖与假设不一致 → Dependency Sync Check → 通知 Owner
- 发现用了已关闭 Issue → 立即停止，新建 OPEN Issue，重建 worktree
- Rulebook task 不存在或验证失败 → 阻断交付，先修复

### 5.3 §6 补充禁令的写法要求

补充禁令只放那些：

1. 能从 P1–P7 推导出来
2. 但历史上反复出现，Agent 经常犯的错误
3. 需要显式提醒的操作级细节

每条必须标注「推导自 Px」。候选项（你从中选取 ≤5 条）：

- 禁止 `any` 类型（推导自 P6：确定性）
- 禁止在组件中直接使用 Tailwind 原始色值（推导自外部设计规范）
- 禁止仅为归档当前任务的 Rulebook task 递归创建 closeout issue（推导自 P5）

---

## §六、质量检查清单

你的产出必须通过以下所有检查项。自查时逐项过一遍。

### 6.1 结构检查

- [ ]  章节数量 ≤ 8
- [ ]  §2（核心原则）占全文比例 ≥ 40%
- [ ]  §6（补充禁令）条目数 ≤ 5
- [ ]  每个章节只做一件事（原则不夹带流程，流程不夹带约束）
- [ ]  信息架构支持渐进式阅读（原则 → 架构 → 流程 → 参考）

### 6.2 冗余检查

- [ ]  任何一条规则在全文中只出现一次（正面和反面表述算同一条）
- [ ]  工作流程章节不重复原则章节的约束（只引用 Px 编号）
- [ ]  参考文档索引不含摘要或重复说明
- [ ]  阅读链与文档速查表之间无信息重复

### 6.3 覆盖检查

- [ ]  当前版本的全部 29 条禁令都能在 P1–P7 + §6 中找到对应
- [ ]  无遗漏的约束力（删减的是冗余表述，不是约束本身）

### 6.4 写法检查

- [ ]  所有 7 条原则使用统一格式（一句话声明 + 解释 + 规则要点 + ✅/❌ 示例）
- [ ]  规则句全部是祈使句或条件句，无叙述句
- [ ]  术语一致性：同一概念全文只用一个词
- [ ]  每条原则至少有 1 个 ✅ 示例和 1 个 ❌ 示例

### 6.5 体积检查

- [ ]  总长度比当前版本缩短 ≥ 30%
- [ ]  无空洞的修饰语和过渡句

---

## §七、交付要求

1. **产出格式**：一份完整的 [`AGENTS.md`](http://AGENTS.md)，Markdown 格式，可直接替换当前文件
2. **产出位置**：输出为完整文件内容
3. **不得包含**：元注释、TODO、占位符、「待补充」字样
4. **必须包含**：当前版本中所有的架构信息（四层 + 12 模块 + Spec 路径）、三体系协作关系、工作流程骨架
5. **自查**：交付前逐项过 §六 的检查清单

---

## §八、当前 [AGENTS.md](http://AGENTS.md) 的位置

当前版本位于项目根目录 [`AGENTS.md`](http://AGENTS.md)。文件中包含两个版本：

- 页面主体内容：旧版（13 章节 + 26 条禁令）
- 末尾代码块中：新版（8 章节 + 29 条禁令），已包含部分外部化和 P1–P7 雏形

两个版本都需要阅读，以理解完整的约束语义。你的产出将替换整个文件。
# 5. 反思与自我修正机制

<aside>
🔄

**核心思想**：AI 不应该"写完就交"——它应该像一个负责任的写作搭档一样，在交稿前先自己审一遍。反思机制让 AI 在生成内容后进行多维度自评，发现问题则自动修正，只把符合质量标准的结果交给用户。

</aside>

---

## 1. 为什么需要反思？

### 没有反思的典型问题

| **问题类型** | **示例** | **发生频率** |
| --- | --- | --- |
| 设定矛盾 | 续写中主角用了左手开门，但知识图谱中记录主角是右撇子 | 高（尤其在长篇创作中） |
| 风格漂移 | 用户偏好简洁风格，AI 生成了华丽的长句 | 中等 |
| 逻辑断裂 | 续写的内容与前文的因果关系不成立 | 中等 |
| 角色失声 | 一个粗犷的角色突然说出了文绉绉的台词 | 高 |
| 节奏失控 | 紧张的追逐场景中插入了大段心理描写 | 低（但影响大） |

---

## 2. 反思循环架构（Reflection Loop）

### 整体流程

```
用户指令
    │
    ▼
┌──────────┐
│ Generator │ → 生成初始内容（Draft v0）
└──────────┘
    │
    ▼
┌──────────┐     不通过     ┌──────────┐
│ Reviewer  │ ──────────► │ Refiner   │ → 修正内容（Draft v1）
└──────────┘              └──────────┘
    │ 通过                      │
    │                          ▼
    │                    ┌──────────┐
    │                    │ Reviewer  │ → 再次审查
    │                    └──────────┘
    │                         │ 通过
    ▼                         ▼
┌──────────────────────────────────┐
│        呈现给用户                  │
│   （附带审查报告 + 修正说明）       │
└──────────────────────────────────┘
```

### 最大迭代次数

反思循环不是无限的：

- **默认最大迭代**：2 轮（生成 → 审查 → 修正 → 再审查）
- **用户可配置**：0 轮（关闭反思）到 3 轮（深度审查）
- **超过最大迭代仍未通过**：标记为"部分通过"，展示给用户并附带未解决的问题列表

---

## 3. 多维度审查器（Multi-Dimensional Reviewer）

### 审查维度

每个维度有独立的检查逻辑和通过标准：

#### 维度 1：设定一致性（Consistency Check）

```tsx
interface ConsistencyCheck {
  // 数据来源
  sources: ['knowledge_graph', 'project_rules'];
  
  // 检查项
  checks: {
    characterConsistency: boolean;   // 角色行为是否符合设定
    worldBuildingRules: boolean;     // 是否违反世界观规则
    timelineConsistency: boolean;    // 时间线是否矛盾
    objectConsistency: boolean;      // 物品/道具是否一致
  };
  
  // 检查方法
  method: 'knowledge_graph_query';   // 查询知识图谱中的实体和规则
}
```

**检查流程**：

1. 从生成内容中提取涉及的实体（角色、地点、物品等）
2. 在知识图谱中查询这些实体的属性和关系
3. 逐项比对：生成内容是否与知识图谱中的记录矛盾
4. 输出矛盾列表（如有）

#### 维度 2：风格匹配（Style Matching）

```tsx
interface StyleCheck {
  // 数据来源
  sources: ['semantic_memory', 'project_settings'];
  
  // 检查项
  checks: {
    sentenceLength: boolean;        // 句长是否符合偏好
    vocabularyLevel: boolean;       // 用词水平是否匹配
    rhetoricalDevices: boolean;     // 修辞手法是否符合偏好
    narrativePerspective: boolean;  // 叙事视角是否一致
  };
  
  // 检查方法
  method: 'style_vector_comparison'; // 计算生成内容与偏好风格的向量距离
}
```

**检查流程**：

1. 从语义记忆中加载用户的风格偏好规则
2. 对生成内容进行风格特征提取（句长分布、词频、修辞密度等）
3. 计算风格偏差分数
4. 如果偏差超过阈值，标记具体的偏差项

#### 维度 3：叙事连贯性（Narrative Coherence）

```tsx
interface CoherenceCheck {
  // 数据来源
  sources: ['immediate_context', 'chapter_outline'];
  
  // 检查项
  checks: {
    causalLogic: boolean;           // 因果逻辑是否成立
    emotionalArc: boolean;          // 情感弧线是否连贯
    sceneTransition: boolean;       // 场景转换是否自然
    informationFlow: boolean;       // 信息是否按合理顺序揭示
  };
  
  // 检查方法
  method: 'ai_reasoning';           // 需要 AI 进行深度推理
}
```

#### 维度 4：角色声音（Character Voice）

```tsx
interface VoiceCheck {
  // 数据来源
  sources: ['knowledge_graph.characters', 'episodic_memory'];
  
  // 检查项
  checks: {
    dialogueAuthenticity: boolean;  // 对白是否符合角色性格
    internalMonologue: boolean;     // 内心独白是否符合角色
    reactionPattern: boolean;       // 反应模式是否符合角色
  };
  
  // 检查方法
  method: 'character_profile_comparison';
}
```

### 审查结果结构

```tsx
interface ReviewResult {
  overallPass: boolean;
  overallScore: number;           // 0-100
  
  dimensions: {
    consistency: DimensionResult;
    style: DimensionResult;
    coherence: DimensionResult;
    characterVoice: DimensionResult;
  };
  
  issues: ReviewIssue[];
  
  // 修正建议
  refinementInstructions: string[];
}

interface ReviewIssue {
  dimension: string;
  severity: 'critical' | 'warning' | 'suggestion';
  description: string;
  location: TextRange;            // 问题在生成文本中的位置
  suggestedFix?: string;
}
```

---

## 4. 修正器（Refiner）

### 修正策略

| **问题严重度** | **修正策略** | **示例** |
| --- | --- | --- |
| 🔴 Critical | 局部重写：保留整体结构，仅重写有问题的段落 | 角色用了错误的手（左/右），重写该动作描写 |
| 🟡 Warning | 微调：在原文基础上做最小修改 | 句子偏长，拆分为两个短句 |
| 🟢 Suggestion | 标注但不自动修改，作为建议展示给用户 | "此处可以加入一个感官细节增强画面感" |

### 修正约束

修正器在修正时必须遵守以下约束：

1. **最小修改原则**：修正应尽可能小，不改变原文的整体结构和剧情走向
2. **保留用户意图**：如果用户在指令中表达了特定意图，修正不能违背
3. **修正可追踪**：每次修正都标记修改位置和原因，用户可以看到 diff
4. **修正不引入新问题**：修正后需要再次通过审查（这就是为什么需要循环）

---

## 5. 用户可见的审查报告

### 简洁模式（默认）

```
✅ 审查通过（2 个建议）
├ 一致性 ✅ | 风格 ✅ | 连贯性 ✅ | 角色声音 ✅
└ 💡 建议：第 3 段可加入环境描写增强氛围
```

### 详细模式（用户点击展开）

```
┌─────────────────────────────────────────────┐
│  📋 审查报告                                  │
├─────────────────────────────────────────────┤
│                                             │
│  ✅ 设定一致性（100/100）                     │
│     所有实体与知识图谱一致                      │
│                                             │
│  ✅ 风格匹配（88/100）                        │
│     平均句长 12.3 字（偏好 < 15 字 ✓）         │
│     修辞密度适中 ✓                            │
│     ⚠️ 第 2 段有一个 28 字的长句（已自动拆分）  │
│                                             │
│  ✅ 叙事连贯性（95/100）                      │
│     因果逻辑成立 ✓                            │
│     场景转换自然 ✓                            │
│                                             │
│  ✅ 角色声音（91/100）                        │
│     林远的对白符合性格设定 ✓                    │
│     💡 建议：可以加入林远的口头禅增强辨识度      │
│                                             │
│  🔄 修正记录                                 │
│     v0 → v1：拆分了第 2 段的长句               │
│                                             │
└─────────────────────────────────────────────┘
```

---

## 6. 反思系统的性能考量

<aside>
⚡

反思循环会增加 AI 调用次数（每轮反思 = 1 次审查调用 + 可能的修正调用），因此需要平衡**质量提升**和**响应速度**。

</aside>

### 优化策略

- **并行审查**：四个维度的审查可以并行执行，减少总延迟
- **轻量审查优先**：设定一致性和风格匹配可以用规则引擎（不调用 AI），仅叙事连贯性和角色声音需要 AI 推理
- **智能跳过**：对于简单任务（如缩写、同义词替换），可以跳过部分审查维度
- **缓存审查结果**：如果修正只影响了局部文本，未改动的部分不需要重新审查

### 预估性能影响

| **场景** | **无反思** | **1 轮反思** | **2 轮反思** |
| --- | --- | --- | --- |
| 续写 200 字 | ~2 秒 | ~3.5 秒 | ~5 秒 |
| 场景改写 | ~4 秒 | ~6.5 秒 | ~9 秒 |
| 跨章节操作 | ~8 秒 | ~12 秒 | ~16 秒 |
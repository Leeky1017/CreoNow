# 5. 核心基座与模式切换机制

<aside>
🔧

**核心思想**：三类创作者模式不是三个独立的产品，而是共享同一个强大基座的三种"视图"。本章定义基座的通用能力边界，以及模式之间的切换和混合机制。

</aside>

---

## 1. 核心基座能力清单

### 基座 = 所有模式共享的底层能力

```
┌─────────────────────────────────────────────────────┐
│                    核心基座 (Core)                    │
├─────────────────────────────────────────────────────┤
│                                                     │
│  🔧 基础设施层                                       │
│  ├ TipTap 富文本编辑器                               │
│  ├ SQLite 本地存储                                   │
│  ├ Electron 桌面框架                                 │
│  ├ 版本管理系统（快照 + Diff + 回滚）                 │
│  └ 文件导入/导出引擎                                  │
│                                                     │
│  🧠 AI 引擎层                                       │
│  ├ 分层上下文引擎（Rules/Settings/Retrieved/Immediate）│
│  ├ 多模型抽象层（OpenAI / Anthropic / 本地模型）       │
│  ├ Prompt 管理与缓存（stablePrefixHash）             │
│  └ 流式生成 + 中断机制                               │
│                                                     │
│  📚 知识管理层                                       │
│  ├ 知识图谱（实体 + 关系 + 规则）                      │
│  ├ 语义检索引擎（embedding + 向量索引）               │
│  └ 全文搜索引擎                                      │
│                                                     │
│  🧠 记忆层                                           │
│  ├ 工作记忆（会话级）                                 │
│  ├ 情景记忆（持久化 + 语义索引）                       │
│  ├ 语义记忆（自动蒸馏 + 用户控制）                     │
│  └ 记忆生命周期管理                                   │
│                                                     │
│  ⚡ 技能层                                           │
│  ├ 通用技能（续写/改写/扩写/缩写/风格迁移）            │
│  ├ 技能编排引擎（串行/并行/条件/循环）                 │
│  ├ 自定义技能框架                                    │
│  └ 技能链保存与复用                                   │
│                                                     │
│  🤖 Agentic 层                                      │
│  ├ 意图解析器                                        │
│  ├ 任务规划器                                        │
│  ├ 执行引擎（全自动/半自动/协作式）                    │
│  ├ 反思循环（多维度审查 + 修正）                       │
│  └ 主动感知框架（可插拔监测器）                        │
│                                                     │
└─────────────────────────────────────────────────────┘
```

---

## 2. 基座 vs 领域工具层的边界

| **能力** | **归属** | **说明** |
| --- | --- | --- |
| 富文本编辑 | 基座 | 所有模式共享编辑器核心 |
| 剧本格式化 | 领域工具 | 通过 TipTap 扩展实现，仅剧本模式加载 |
| 知识图谱引擎 | 基座 | 引擎通用，但实体类型由 Profile 配置 |
| 角色弧光可视化 | 领域工具 | 基于知识图谱数据，仅小说模式可用 |
| 续写/改写技能 | 基座 | 通用技能，所有模式可用 |
| 对白生成技能 | 领域工具 | 剧本模式专用技能 |
| 反思循环引擎 | 基座 | 引擎通用，但审查维度由 Profile 配置 |
| SEO 审查 | 领域工具 | 自媒体模式专用审查维度 |
| 主动感知框架 | 基座 | 框架通用，但监测器由 Profile 配置 |
| 伏笔追踪器 | 领域工具 | 小说模式专用监测器 |

### 设计原则

> **基座提供"引擎"，领域工具提供"配置"。**
> 

> 
> 

> 知识图谱引擎是基座能力，但"角色"这个实体类型是小说模式的配置；反思循环是基座能力，但"格式规范审查"是剧本模式的配置。这样做的好处是：**基座只需要维护一套代码，领域差异全部通过配置实现。**
> 

---

## 3. 模式切换机制

### 切换场景

| **场景** | **处理方式** | **数据影响** |
| --- | --- | --- |
| 创建新项目时选择模式 | 直接应用 Profile 配置 | 无（新项目） |
| 已有项目切换模式 | 重新配置 UI、技能、审查，保留所有数据 | 数据不丢失，重新组织呈现 |
| 临时启用其他模式的工具 | 在当前模式基础上"混入"工具 | 无数据变化 |

### 切换流程

```tsx
class ProfileSwitcher {
  async switchProfile(
    project: Project, 
    newProfile: CreatorProfile
  ): Promise<void> {
    
    // 1. 保存当前状态快照
    await this.createSnapshot(project);
    
    // 2. 重新配置 UI
    this.reconfigureUI(newProfile.ui);
    
    // 3. 重新加载技能集
    this.reloadSkills(newProfile.skills);
    
    // 4. 重新配置知识图谱的实体类型
    // 注意：不删除已有实体，只改变可见的类型列表
    this.reconfigureKnowledgeGraph(newProfile.knowledgeGraph);
    
    // 5. 重新配置审查维度
    this.reconfigureReview(newProfile.review);
    
    // 6. 重新配置主动感知
    this.reconfigurePerception(newProfile.proactivePerception);
    
    // 7. 重新组织记忆的分类标签
    await this.reorganizeMemoryTags(newProfile);
    
    // 8. 通知用户切换完成
    this.notifyUser('模式已切换到: ' + newProfile.name);
  }
}
```

---

## 4. 混合模式的实现

### 为什么需要混合？

真实创作场景经常跨界：

- 自媒体作者写连载小说 → 需要小说模式的知识图谱 + 自媒体模式的 SEO
- 编剧同时写剧本小说 → 需要剧本格式 + 小说模式的叙事工具
- 小说家在知乎连载 → 需要小说模式全套 + 自媒体模式的平台适配

### 混合机制

```tsx
interface ProfileMixin {
  baseProfile: CreatorProfile;     // 基础模式
  
  // 混入的工具
  additionalTools: {
    fromProfile: string;           // 来自哪个模式
    toolId: string;                // 工具 ID
    enabled: boolean;
  }[];
  
  // 混入的审查维度
  additionalReviewDimensions: ReviewDimension[];
  
  // 混入的技能
  additionalSkills: string[];
  
  // 混入的导出格式
  additionalExportFormats: ExportFormat[];
}
```

### 混合模式 UI

```
⚙️ 模式配置                     当前: 📖 小说模式

基础工具: ✅ 全部启用

从其他模式混入:
┌────────────────────────────────────────────────┐
│  🎬 剧本模式                                    │
│  ├ ☐ 剧本格式化引擎                             │
│  ├ ☐ 场景卡片系统                               │
│  ├ ☐ 角色台词分析器  ← 💡 推荐（你的项目有大量对白）│
│  └ ☐ Table Read 模拟器                          │
│                                                │
│  📱 自媒体模式                                   │
│  ├ ☑️ 可读性评分面板  ← 已启用                    │
│  ├ ☑️ 多平台适配格式器 ← 已启用                   │
│  ├ ☐ SEO 优化建议器                              │
│  └ ☐ 热点关联引擎                                │
└────────────────────────────────────────────────┘

💡 智能推荐: 检测到你的项目有 40% 的内容是对白，
   建议启用"角色台词分析器"来优化对白质量。
```

---

## 5. 领域工具的动态加载

### 懒加载策略

<aside>
⚡

**性能原则**：未启用的领域工具不占用内存和 CPU。所有领域工具通过懒加载实现。

</aside>

```tsx
class ToolLoader {
  private loadedTools: Map<string, Tool> = new Map();
  
  async loadTool(toolId: string): Promise<Tool> {
    // 检查是否已加载
    if (this.loadedTools.has(toolId)) {
      return this.loadedTools.get(toolId)!;
    }
    
    // 动态导入工具模块
    const module = await import(`./tools/${toolId}`);
    const tool = new module.default();
    
    // 初始化工具（注入基座依赖）
    await tool.initialize({
      knowledgeGraph: this.core.knowledgeGraph,
      memorySystem: this.core.memorySystem,
      aiEngine: this.core.aiEngine,
      editor: this.core.editor,
    });
    
    this.loadedTools.set(toolId, tool);
    return tool;
  }
  
  async unloadTool(toolId: string): Promise<void> {
    const tool = this.loadedTools.get(toolId);
    if (tool) {
      await tool.dispose();
      this.loadedTools.delete(toolId);
    }
  }
}
```

---

## 6. 扩展性：自定义领域工具（远期）

### 插件 API（远期目标）

允许社区和高级用户开发自定义领域工具：

```tsx
interface ToolPlugin {
  id: string;
  name: string;
  version: string;
  
  // 工具定义
  tools: ToolDefinition[];
  
  // 技能定义
  skills: SkillDefinition[];
  
  // 审查维度定义
  reviewDimensions: ReviewDimension[];
  
  // 主动感知监测器定义
  monitors: MonitorDefinition[];
  
  // 知识图谱实体类型扩展
  entityTypes: EntityType[];
  
  // UI 组件
  sidebarPanels: PanelDefinition[];
  toolbarButtons: ButtonDefinition[];
}
```

### 可能的社区插件示例

| **插件** | **功能** | **适用创作者** |
| --- | --- | --- |
| 推理小说助手 | 线索管理、嫌疑人追踪、不在场证明验证 | 推理小说作者 |
| 诗歌韵律分析 | 押韵检测、格律分析、音节计数 | 诗人 |
| 学术写作助手 | 引用管理、论文结构、文献关联 | 学术研究者 |
| 游戏叙事设计 | 分支对白管理、选择树、多结局追踪 | 游戏叙事设计师 |
| 方言/古文顾问 | 方言用词检查、古文语法审查 | 历史小说/地方文学创作者 |

---

## 7. 总结：架构层次图

```
┌─────────────────────────────────────────────────────────┐
│                     用户界面层                            │
│  ┌──────────┐  ┌──────────┐  ┌──────────────┐          │
│  │📖 小说 UI │  │🎬 剧本 UI │  │📱 自媒体 UI  │          │
│  └──────────┘  └──────────┘  └──────────────┘          │
├─────────────────────────────────────────────────────────┤
│                    领域工具层                             │
│  ┌──────────┐  ┌──────────┐  ┌──────────────┐          │
│  │大纲编辑器 │  │剧本格式化 │  │标题生成器    │ ...       │
│  │角色弧光   │  │Beat Sheet│  │可读性评分    │           │
│  │时间线     │  │台词分析   │  │平台适配     │           │
│  └──────────┘  └──────────┘  └──────────────┘          │
├─────────────────────────────────────────────────────────┤
│               Profile 配置层（桥梁）                      │
│  ┌─────────────────────────────────────────────────┐    │
│  │ UI 配置 | 技能配置 | 审查配置 | 图谱配置 | 导出配置 │    │
│  └─────────────────────────────────────────────────┘    │
├─────────────────────────────────────────────────────────┤
│                    核心基座层                             │
│  ┌─────────┐ ┌────────┐ ┌──────┐ ┌───────┐ ┌──────┐  │
│  │AI 引擎   │ │知识图谱 │ │记忆   │ │技能    │ │Agentic│  │
│  │(上下文   │ │(实体   │ │(三层  │ │(编排   │ │(规划  │  │
│  │ 引擎)    │ │ +关系)  │ │ 记忆) │ │ 引擎)  │ │+反思) │  │
│  └─────────┘ └────────┘ └──────┘ └───────┘ └──────┘  │
├─────────────────────────────────────────────────────────┤
│                    基础设施层                             │
│  ┌──────────┐ ┌────────┐ ┌──────────┐ ┌──────────┐    │
│  │ Electron  │ │ SQLite  │ │ TipTap 2  │ │版本管理   │    │
│  └──────────┘ └────────┘ └──────────┘ └──────────┘    │
└─────────────────────────────────────────────────────────┘
```
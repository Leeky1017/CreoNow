# CN 全量代码严格审计报告（Swarm Leader 复核版）

审计日期：2026-02-15  
审计范围：`apps/desktop/main/src`、`apps/desktop/preload/src`、`apps/desktop/renderer/src`、`apps/desktop/tests`、`package.json`、`.github/workflows/*`  
基线：`docs/代码问题/*.md`（12 类）+ `AGENTS.md` + `openspec/project.md` + `docs/delivery-skill.md`

## 1. Swarm Team 组织与任务拆解

- Leader：主会话（汇总、交叉验证、最终分级）
- Teammate A（main-backend-auditor）：`apps/desktop/main/src`，主进程稳定性/架构/静默失败
- Teammate B（renderer-auditor）：`apps/desktop/renderer/src`，UI 异步流程与表面正确
- Teammate C（preload-ipc-auditor）：`preload + ipc + shared`，契约与安全边界
- Teammate D（tests-quality-auditor）：`tests + workflows + scripts`，门禁与覆盖真实性
- Teammate E（crosscutting-auditor）：跨目录重复链路/架构退化/隐蔽高影响问题

## 2. 审计方法（严格模式）

- 静态全量扫描：`apps/desktop` 下 TS/TSX/JS 共 **808** 文件。
- 热点聚焦：大文件、`catch`、`void (async ...)`、`invoke()` 异步链路、IPC 通道权限、测试脚本覆盖差异。
- 并行子代理审计 + Leader 逐条复核（以源码行为为准，过滤不可靠结论）。
- 门禁真实性校验：对比 `package.json` 测试脚本与目录内真实测试文件清单。

## 3. 关键发现（按严重级别）

## Critical

### C1. 渲染层存在系统性“异步失败不落地”问题，容易形成“表面正确”

- 对应问题类型：`静默失败与表面正确`、`过度防御性降级与保守回退`
- 证据（节选）：
  - `apps/desktop/renderer/src/features/memory/MemoryPanel.tsx:173`
  - `apps/desktop/renderer/src/features/memory/MemoryPanel.tsx:201`
  - `apps/desktop/renderer/src/features/memory/MemoryPanel.tsx:233`
  - `apps/desktop/renderer/src/features/memory/MemoryPanel.tsx:284`
  - `apps/desktop/renderer/src/features/rightpanel/QualityPanel.tsx:380`
  - `apps/desktop/renderer/src/features/rightpanel/InfoPanel.tsx:242`
  - `apps/desktop/renderer/src/features/settings/ProxySection.tsx:63`
  - `apps/desktop/renderer/src/stores/versionStore.tsx:231`
  - `apps/desktop/renderer/src/stores/editorStore.tsx:193`
  - `apps/desktop/renderer/src/stores/projectStore.tsx:144`
  - `apps/desktop/renderer/src/components/layout/AppShell.tsx:434`
  - `apps/desktop/renderer/src/components/layout/AppShell.tsx:469`
  - `apps/desktop/renderer/src/features/settings/JudgeSection.tsx:39`
- 现象：大量 `await invoke(...)` 假定只会返回 `{ ok: false }`，但未覆盖 Promise reject；部分流程会出现 loading 卡住、状态不一致、错误不可见。
- 根因：缺少统一异步错误收敛约定；`void (async () => ...)()` 在多个关键入口被直接使用且无外层兜底。
- 修复方向：
  - 建立统一 `safeInvoke()`（reject -> 统一错误结构），禁止页面层裸 `invoke()`。
  - 所有状态型异步逻辑统一 `try/catch/finally`，`finally` 必须收敛 loading 状态。
  - 增加 lint 规则：禁止无 `catch` 的 `void (async () => ...)()`。

### C2. 测试门禁存在“虚假覆盖率”，大量测试文件未被执行

- 对应问题类型：`虚假测试覆盖率`、`Bug 重现与跨会话错误传播`
- 证据：
  - `package.json:13`（`test:unit` 手工白名单）
  - `package.json:14`（`test:integration` 手工白名单）
  - `apps/desktop/vitest.config.ts:40`（`include` 仅 `renderer/src/**/*.test.{ts,tsx}`）
  - `.github/workflows/ci.yml:25`（CI 仅调用 `pnpm test:unit`、`pnpm test:integration`、`pnpm -C apps/desktop test:run`）
- 量化结果（Leader 复核命令）：
  - **15** 个 integration 测试文件未被 `test:integration` 引用
  - **2** 个 perf benchmark 文件未被任何 CI 脚本引用
  - **34** 个 `apps/desktop/tests/unit` 测试文件未在 `test:unit` 白名单中
  - **59** 个 `apps/desktop/main/src/**/__tests__` 测试文件未在 `test:unit` 白名单中
- 典型漏测文件：
  - `apps/desktop/tests/integration/ai-provider-unavailable-degrade.test.ts`
  - `apps/desktop/tests/integration/project-lifecycle.state-machine.test.ts`
  - `apps/desktop/tests/perf/project-lifecycle.benchmark.test.ts`
  - `apps/desktop/main/src/ipc/__tests__/ai-chat-project-isolation.test.ts`
- 根因：测试执行策略采用手工路径白名单 + 渲染层限定 include，无法覆盖新增测试。
- 修复方向：
  - 用目录/项目级发现替代白名单（Vitest projects 或 glob）。
  - CI 将“发现到的测试总数”与“实际执行总数”做一致性校验。
  - 为 integration/perf 设置独立 gate，禁止“存在测试文件但不执行”。

### C3. IPC 项目作用域安全边界不足：依赖 `projectId` 字符串而非会话授权

- 对应问题类型：`安全漏洞与输入校验缺失`
- 证据：
  - `apps/desktop/main/src/ipc/ai.ts:302`（`resolveChatProjectId` 仅校验非空）
  - `apps/desktop/main/src/ipc/ai.ts:979`（`ai:chat:send/list/clear` 直接按 `projectId` 访问内存会话）
  - `apps/desktop/main/src/ipc/contextFs.ts:227`（`context:watch:stop` 未做 start 同级别 DB/目录校验）
  - `apps/desktop/main/src/ipc/contextFs.ts:265`（`context:rules:list/settings:list` 仅凭 projectId 查询）
  - `apps/desktop/main/src/ipc/ipcAcl.ts:25`（privileged 前缀覆盖范围过窄）
- 现象：调用方只要拿到任意 projectId 即可尝试操作对应项目的部分 IPC 能力。
- 根因：ACL 以来源校验为主，缺少“调用者会话 ↔ projectId”的强绑定授权。
- 修复方向：
  - 在主进程维护 `webContentsId -> activeProjectId` 绑定并强校验。
  - 高敏 IPC（chat/contextFs/knowledge/memory）引入统一 `assertProjectAccess(event, projectId)`。
  - 扩展 ACL privileged 范围，不再只靠 channel 前缀少量匹配。

## High

### H1. `project bundle` 导出在主进程一次性拼接全量文本，存在内存峰值风险

- 对应问题类型：`静默失败与表面正确`
- 证据：`apps/desktop/main/src/services/export/exportService.ts:284`
- 现象：先收集 `sections[]` 再 `join()`，大项目导出会放大内存占用，可能卡死或 OOM。
- 根因：未采用流式写入。
- 修复方向：改为分段写流（stream write），并加入导出大小阈值/分片策略。

### H2. 主进程关键链路仍有同步文件 I/O，阻塞 IPC 事件循环

- 对应问题类型：`架构退化与单体回归`、`风格漂移与项目约定偏离`
- 证据：
  - `apps/desktop/main/src/services/skills/skillService.ts:691`
  - `apps/desktop/main/src/services/context/contextFs.ts:53`
  - `apps/desktop/main/src/services/context/contextFs.ts:96`
- 现象：`readFileSync/writeFileSync/statSync/readdirSync` 出现在 IPC 热路径。
- 根因：为实现简便牺牲主线程可用性。
- 修复方向：迁移到 `fs.promises` 或 worker 线程；慢 I/O 统一异步化。

### H3. watcher 异常后仅日志记录，不对外暴露“已失效”状态

- 对应问题类型：`静默失败与表面正确`
- 证据：`apps/desktop/main/src/services/context/watchService.ts:81`
- 现象：watcher 报错后 UI 仍可能认为在 watching。
- 根因：`watcher.on("error")` 仅写日志，不回写状态机。
- 修复方向：错误事件触发 watcher 移除、状态回收、通知上层可重试。

### H4. `AiPanel` Judge 自动评估存在一次失败后“不可重试”风险

- 对应问题类型：`静默失败与表面正确`
- 证据：`apps/desktop/renderer/src/features/ai/AiPanel.tsx:705`
- 现象：先写 `evaluatedRunIdRef` 再 fire-and-forget invoke，失败后该 runId 不再重试。
- 根因：缺少失败回滚策略。
- 修复方向：失败时重置 `evaluatedRunIdRef`，并将评估状态显式化。

### H5. preload payload 体积校验前仍需全量 `JSON.stringify`，大负载下内存开销高

- 对应问题类型：`过度防御性降级与保守回退`
- 证据：`apps/desktop/preload/src/ipcGateway.ts:100`
- 现象：即使最终拒绝请求，也先序列化完整 payload。
- 根因：size 估算与拦截顺序设计不优。
- 修复方向：引入分块传输协议；大对象改流式/分段 IPC；保留阈值但避免整包序列化。

### H6. 架构“单体回归”显著：核心文件规模已进入高风险区

- 对应问题类型：`架构退化与单体回归`、`重构回避与只增不改`
- 证据（行数）：
  - `apps/desktop/main/src/services/memory/episodicMemoryService.ts`（2478）
  - `apps/desktop/main/src/services/documents/documentCoreService.ts`（2439）
  - `apps/desktop/main/src/services/ai/aiService.ts`（1861）
  - `apps/desktop/main/src/services/skills/skillService.ts`（1598）
  - `apps/desktop/renderer/src/features/ai/AiPanel.tsx`（1596）
  - `apps/desktop/renderer/src/components/layout/AppShell.tsx`（1021）
- 现象：跨职责混合严重，变更影响面过大。
- 根因：长期“加逻辑优先，拆职责滞后”。
- 修复方向：按能力边界做 service/router/view-model 拆分，新增逻辑先落子模块。

## Medium

### M1. AI 运行时关键参数仍硬编码在 service，治理配置集中度不足

- 对应问题类型：`风格漂移与项目约定偏离`
- 证据：`apps/desktop/main/src/services/ai/aiService.ts:117`
- 现象：限流/超时/token 参数在代码内固定。
- 根因：runtime governance 与 AI service 未完全对齐。
- 修复方向：统一移入 runtime governance 配置并支持环境覆盖。

### M2. Token 预算/截断逻辑跨模块重复实现，存在契约漂移风险

- 对应问题类型：`重复链路与冗余逻辑`
- 证据：
  - `apps/desktop/main/src/services/context/layerAssemblyService.ts:175`
  - `apps/desktop/renderer/src/lib/ai/contextAssembler.ts:171`
  - `apps/desktop/main/src/services/rag/ragService.ts:144`
- 现象：各处自行估算 token/字节，行为一致性依赖人工同步。
- 根因：缺少 shared helper。
- 修复方向：抽取 `@shared/tokenBudget`，统一估算与裁剪策略。

### M3. 测试 mock 与生产 token 口径不一致，降低预算类测试可信度

- 对应问题类型：`虚假测试覆盖率`
- 证据：`apps/desktop/tests/helpers/llm-mock.ts:59`
- 现象：mock 用“按空格计词”近似 token，与生产估算规则不一致。
- 根因：测试 helper 未复用生产 token 估算。
- 修复方向：测试侧复用同一估算器，或明确建立“误差容忍契约”。

### M4. preload 对不可序列化 payload 的诊断信息不足

- 对应问题类型：`静默失败与表面正确`
- 证据：`apps/desktop/preload/src/ipcGateway.ts:155`
- 现象：仅返回 `INVALID_ARGUMENT`，缺少可定位上下文。
- 根因：错误映射过于泛化。
- 修复方向：增加可审计 metadata（结构摘要/字段路径）与专用错误码。

### M5. 覆盖率脚本存在但 CI 不执行，质量信号缺口

- 对应问题类型：`虚假测试覆盖率`
- 证据：
  - `apps/desktop/package.json:12`（`test:coverage`）
  - `.github/workflows/ci.yml:25`（未调用）
- 现象：无持续 coverage 趋势，难发现隐性回退。
- 根因：CI 仅关注通过/失败，不验证覆盖约束。
- 修复方向：新增 coverage gate + artifact 上传 + 变更阈值策略。

## 4. 对照 `docs/代码问题` 的 12 类覆盖矩阵

| 问题类别                 | 审计结论                               |
| ------------------------ | -------------------------------------- |
| Bug 重现与跨会话错误传播 | 已命中（C2：门禁漏测导致回归可重复）   |
| 安全漏洞与输入校验缺失   | 已命中（C3）                           |
| 幽灵 Bug 与边界过度处理  | 暂未发现明确高风险实例                 |
| 架构退化与单体回归       | 已命中（H6）                           |
| 注释泛滥与噪音代码       | 暂未发现明确高风险实例                 |
| 虚假测试覆盖率           | 已命中（C2、M5）                       |
| 辅助函数滥用与过度抽象   | 存在局部风险，但本轮未列为高优先级缺陷 |
| 过度防御性降级与保守回退 | 已命中（C1、H5、M4）                   |
| 重复链路与冗余逻辑       | 已命中（M2）                           |
| 重构回避与只增不改       | 已命中（H6）                           |
| 静默失败与表面正确       | 已命中（C1、H3、H4）                   |
| 风格漂移与项目约定偏离   | 已命中（H2、M1）                       |

## 5. 修复优先级建议（可执行）

1. P0（本周）：

- 统一 renderer/store `invoke` 异常收敛（先修 C1 涉及的关键页面与 store）。
- 修复 IPC project scope 授权链（C3）。
- 修复 CI 漏测：integration/perf/main-tests 全纳入执行（C2）。

2. P1（次周）：

- 导出流式化（H1）。
- 清理主线程同步 I/O（H2）。
- watcher 失败可观测与状态回收（H3）。

3. P2（两到三周）：

- 单体大文件拆分计划（H6）。
- token budget 逻辑共享化（M2）与测试口径对齐（M3）。
- 覆盖率门禁接入（M5）。

## 6. 额外说明（本轮新增隐藏问题）

本轮除对照 `docs/代码问题` 外，额外识别到两类“未在文档中直接点名但高影响”的风险：

- `IPC project scope authorization` 缺口（C3）：这是本地多 project 场景中的核心数据隔离问题。
- `测试执行清单与真实测试目录长期漂移`（C2）：这是导致“你以为测到了、实际上没测到”的根因。

# [A6健壮性审计员] 审计报告

## 审计摘要
- 扫描文件数：661
- 发现问题总数：9
- 严重（Critical）：0 | 高危（High）：3 | 中危（Medium）：4 | 低危（Low）：2

## 🔴 严重问题（Critical）
- 本轮未发现 Critical 级别问题。

## 🟠 高危问题（High）
### [A6-H-001] 窗口加载 Promise 未兜底
- 文件：`apps/desktop/main/src/index.ts`
- 行号/范围：L112-L115
- 问题类型：异步操作完整性（未处理 rejection）
- 描述：`BrowserWindow.loadURL/loadFile` 返回 Promise 被 `void` 丢弃。
- 代码片段：
```ts
if (process.env.VITE_DEV_SERVER_URL) {
  void win.loadURL(process.env.VITE_DEV_SERVER_URL);
} else {
  void win.loadFile(path.join(__dirname, "../renderer/index.html"));
}
```
- 风险：加载失败时错误链断裂，可能出现启动黑屏且无可观测日志。
- 建议修复：`await` 或 `.catch(...)` 记录错误并触发降级。
- 优先级：P1

### [A6-H-002] app.whenReady 初始化链无统一 catch
- 文件：`apps/desktop/main/src/index.ts`
- 行号/范围：L339-L378
- 问题类型：异步操作完整性（顶层 Promise 链未兜底）
- 描述：`app.whenReady().then(...)` 无 `.catch`，初始化任一点抛错会成为未处理 rejection。
- 代码片段：
```ts
void app.whenReady().then(() => {
  // init db / register ipc / create window
});
```
- 风险：主进程启动失败时无统一错误处理，进入不可观测异常状态。
- 建议修复：链尾增加 `.catch` 并执行 `app.quit()` 或改 async/try-catch。
- 优先级：P1

### [A6-H-003] KG Panel 异步写入缺少结果校验
- 文件：`apps/desktop/renderer/src/features/kg/KnowledgeGraphPanel.tsx`
- 行号/范围：L219-L223, L325-L331, L347-L367
- 问题类型：错误传播链不完整 + 并发一致性
- 描述：多处异步调用未检查 `ServiceResult.ok`；失败后仍更新本地状态。`Promise.all` 批量更新无补偿。
- 代码片段：
```ts
await relationDelete({ relationId });
if (editing.mode === "relation" && editing.relationId === relationId) {
  setEditing({ mode: "idle" });
}

await entityUpdate({ entityId: nodeId, patch: { metadataJson: updatedMetadata } });
saveKgViewPreferences(props.projectId, { lastDraggedNodeId: nodeId });

await Promise.all(
  orderedIds.map(async (entityId, index) => {
    await entityUpdate({ entityId, patch: { metadataJson } });
  }),
);
```
- 风险：后端失败但前端显示成功，UI 与数据源分叉。
- 建议修复：统一检查返回值并中断后续动作；批量更新改 `allSettled` + 失败汇总。
- 优先级：P1

## 🟡 中危问题（Medium）
### [A6-M-001] MemoryPanel Promise.all 异常路径未包裹
- 文件：`apps/desktop/renderer/src/features/memory/MemoryPanel.tsx`
- 行号/范围：L80-L84, L103-L105
- 问题类型：异步操作完整性（疑似未处理 rejection）
- 描述：effect 中 `void loadPanelData()`，若 `invoke` 抛异常，可能出现未处理 rejection。
- 代码片段：
```ts
const [listRes, settingsRes] = await Promise.all([
  invoke("memory:semantic:list", { projectId }),
  invoke("memory:settings:get", {}),
]);

React.useEffect(() => {
  void loadPanelData();
}, [loadPanelData]);
```
- 风险：面板卡在 loading，错误上下文丢失。
- 建议修复：在 `loadPanelData` 外层加 try/catch 并统一 `setStatus("error")`。
- 优先级：P2

### [A6-M-002] 项目切换竞态覆盖旧数据
- 文件：`apps/desktop/renderer/src/stores/kgStore.ts`
- 行号/范围：L216-L235
- 问题类型：并发安全（竞态条件）
- 描述：`bootstrapForProject` 异步返回后直接 `set`，未校验当前 `projectId` 是否仍匹配发起上下文。
- 代码片段：
```ts
set({ projectId, bootstrapStatus: "loading", ... });
const res = await refreshProjectData(projectId);
...
set({ bootstrapStatus: "ready", entities: res.entities, relations: res.relations });
```
- 风险：快速切换项目时，旧请求晚到覆盖新项目状态。
- 建议修复：引入 requestId/epoch，落库前校验 `get().projectId === projectId`。
- 优先级：P2

### [A6-M-003] SearchStore 查询竞态
- 文件：`apps/desktop/renderer/src/stores/searchStore.ts`
- 行号/范围：L75-L113
- 问题类型：并发安全（查询竞态）
- 描述：请求发起和结果提交间未校验 query 是否仍最新。
- 代码片段：
```ts
const query = get().query;
const res = await deps.invoke("search:fts:query", { projectId, query, limit, offset: 0 });
set({ status: "ready", items: res.data.results, ... });
```
- 风险：后返回旧请求覆盖新查询结果。
- 建议修复：增加请求戳/AbortController，并在提交前比对 query。
- 优先级：P2

### [A6-M-004] SkillScheduler completion catch 吞错
- 文件：`apps/desktop/main/src/services/skills/skillScheduler.ts`
- 行号/范围：L272-L278
- 问题类型：错误传播链完整性
- 描述：`completion` 的 catch 丢弃 error，仅标记 failed。
- 代码片段：
```ts
void started.completion
  .then((terminal) => { finalizeTask(sessionKey, task, terminal); })
  .catch(() => { finalizeTask(sessionKey, task, "failed"); });
```
- 风险：调度异常原因不可追踪，运维与重试策略缺少依据。
- 建议修复：catch 中记录错误详情并透传任务上下文。
- 优先级：P2

## 🔵 低危问题（Low）
### [A6-L-001] Preload IPC listener 生命周期疑似泄露
- 文件：`apps/desktop/preload/src/aiStreamBridge.ts`
- 行号/范围：L128-L150
- 问题类型：资源泄露（疑似）
- 描述：`ipcRenderer.on(...)` 注册后未见 `off/removeListener` 释放路径。
- 代码片段：
```ts
ipcRenderer.on(SKILL_STREAM_CHUNK_CHANNEL, ...);
ipcRenderer.on(SKILL_STREAM_DONE_CHANNEL, ...);
ipcRenderer.on(SKILL_QUEUE_STATUS_CHANNEL, ...);
ipcRenderer.on(JUDGE_RESULT_CHANNEL, ...);
```
- 风险：热更新/异常重建时可能叠加监听器，导致重复事件和内存增长。
- 建议修复：返回 `dispose()` 并在生命周期结束时移除监听器。
- 优先级：P3

### [A6-L-002] 关闭流程定时器未清理
- 文件：`apps/desktop/renderer/src/features/character/AddRelationshipPopover.tsx`
- 行号/范围：L102, L126
- 问题类型：内存泄露模式（疑似）
- 描述：`setTimeout(handleReset, 150)` 未统一清理，组件提前卸载可能执行过期回调。
- 代码片段：
```ts
setTimeout(handleReset, 150);
...
if (!newOpen) {
  setTimeout(handleReset, 150);
}
```
- 风险：低概率触发卸载后状态写入或无效更新累积。
- 建议修复：保存 timer id 并在 cleanup 中 `clearTimeout`。
- 优先级：P3

## 模式统计
- 异步操作完整性：3
- 错误传播链完整性：3
- 并发安全：3
- 资源泄露：1
- 内存泄露模式：1

# [A5æ¶æ„åˆè§„å®¡è®¡å‘˜] å®¡è®¡æŠ¥å‘Š

## å®¡è®¡æ‘˜è¦
- æ‰«ææ–‡ä»¶æ•°ï¼š661
- å‘ç°é—®é¢˜æ€»æ•°ï¼š8
- ä¸¥é‡ï¼ˆCriticalï¼‰ï¼š1 | é«˜å±ï¼ˆHighï¼‰ï¼š3 | ä¸­å±ï¼ˆMediumï¼‰ï¼š2 | ä½å±ï¼ˆLowï¼‰ï¼š2

## ğŸ”´ ä¸¥é‡é—®é¢˜ï¼ˆCriticalï¼‰
### [A5-C-001] Context è£…é…é“¾è·¯å¾ªç¯ä¾èµ–
- æ–‡ä»¶ï¼š`apps/desktop/main/src/services/context/layerAssemblyService.ts`
- è¡Œå·/èŒƒå›´ï¼šL6-L8
- é—®é¢˜ç±»å‹ï¼šå¾ªç¯ä¾èµ–ï¼ˆæ ¸å¿ƒä¸Šä¸‹æ–‡é“¾è·¯ï¼‰
- æè¿°ï¼š`layerAssemblyService` ä¾èµ– fetchersï¼›fetcher åå‘ä¾èµ– `layerAssemblyService` ç±»å‹ï¼Œä¸” `retrievedFetcher` ä¾èµ– `rulesFetcher`ï¼Œå½¢æˆé—­ç¯ã€‚
- ä»£ç ç‰‡æ®µï¼š
```ts
import { createRetrievedFetcher } from "./fetchers/retrievedFetcher";
import { createRulesFetcher } from "./fetchers/rulesFetcher";
import { createSettingsFetcher } from "./fetchers/settingsFetcher";
```
- é£é™©ï¼šæ ¸å¿ƒæ¨¡å—è€¦åˆé—­ç¯ï¼Œé‡æ„æ˜“è§¦å‘è¿é”ä¿®æ”¹å’Œåˆå§‹åŒ–é¡ºåºé£é™©ã€‚
- å»ºè®®ä¿®å¤ï¼šæŠ½ç¦» `ContextLayerFetcher` åˆ°ç‹¬ç«‹ typesï¼›ä¸‹æ²‰ `formatEntityForContext` åˆ°çº¯å·¥å…·æ¨¡å—æ‰“æ–­ç¯ã€‚
- ä¼˜å…ˆçº§ï¼šP0

## ğŸŸ  é«˜å±é—®é¢˜ï¼ˆHighï¼‰
### [A5-H-001] å¸ƒå±€å±‚ä¸åŠŸèƒ½å±‚å¾ªç¯ä¾èµ–
- æ–‡ä»¶ï¼š`apps/desktop/renderer/src/components/layout/RightPanel.tsx`
- è¡Œå·/èŒƒå›´ï¼šL8
- é—®é¢˜ç±»å‹ï¼šå¾ªç¯ä¾èµ–ï¼ˆUI åˆ†å±‚åè½¬ï¼‰
- æè¿°ï¼š`RightPanel` å¼•å…¥ `AiPanel`ï¼›`AiPanel` å†å¼•å…¥ `RightPanel` æš´éœ²çš„ hookã€‚
- ä»£ç ç‰‡æ®µï¼š
```ts
// RightPanel.tsx
import { AiPanel } from "../../features/ai/AiPanel";

// AiPanel.tsx
import { useOpenSettings } from "../../components/layout/RightPanel";
```
- é£é™©ï¼šé¢æ¿/åŠŸèƒ½æ¨¡å—éš¾ç‹¬ç«‹æµ‹è¯•ä¸æ›¿æ¢ï¼Œæ¸²æŸ“å±‚éšå¼è€¦åˆåŠ æ·±ã€‚
- å»ºè®®ä¿®å¤ï¼šæŠ½å‡ºç‹¬ç«‹ context/hook ä¾›åŒæ–¹ä¾èµ–ã€‚
- ä¼˜å…ˆçº§ï¼šP1

### [A5-H-002] DocumentService æˆä¸º God Object
- æ–‡ä»¶ï¼š`apps/desktop/main/src/services/documents/documentService.ts`
- è¡Œå·/èŒƒå›´ï¼šL300, L655, L863
- é—®é¢˜ç±»å‹ï¼šæ¶æ„é€€åŒ–/å•ä½“å›å½’
- æè¿°ï¼šåŒä¸€æœåŠ¡åŒæ—¶æ‰¿è½½ diffã€branch/settings æŒä¹…åŒ–ã€æ–‡æ¡£ CRUDã€ç‰ˆæœ¬åˆå¹¶ã€‚
- ä»£ç ç‰‡æ®µï¼š
```ts
function diffLines(oldLines: string[], newLines: string[]): DiffOp[] { ... }
function readCurrentDocumentId(db: Database.Database, projectId: string) { ... }
export function createDocumentService(args: { ... }) { ... }
```
- é£é™©ï¼šå˜æ›´é¢è¿‡å¤§ï¼Œç¼ºé™·å®šä½å’Œå›å½’æµ‹è¯•æˆæœ¬æŒç»­ä¸Šå‡ã€‚
- å»ºè®®ä¿®å¤ï¼šæŒ‰èƒ½åŠ›æ‹†åˆ†ä¸º CRUDã€ç‰ˆæœ¬ã€åˆ†æ”¯ã€diff å­æœåŠ¡ã€‚
- ä¼˜å…ˆçº§ï¼šP1

### [A5-H-003] AI Service æˆä¸º God Object
- æ–‡ä»¶ï¼š`apps/desktop/main/src/services/ai/aiService.ts`
- è¡Œå·/èŒƒå›´ï¼šL206, L769, L981
- é—®é¢˜ç±»å‹ï¼šæ¶æ„é€€åŒ–/å•ä½“å›å½’
- æè¿°ï¼šèšåˆ token ä¼°ç®—ã€env è§£æã€provider è·¯ç”±ã€é”™è¯¯æ˜ å°„ã€è¿è¡Œæ—¶è°ƒåº¦ã€‚
- ä»£ç ç‰‡æ®µï¼š
```ts
function estimateTokenCount(text: string): number { ... }
export function mapUpstreamStatusToIpcErrorCode(status: number): IpcErrorCode { ... }
export function createAiService(deps: { ... }): AiService { ... }
```
- é£é™©ï¼šåè®®ã€é…ç½®ã€è¿è¡Œè€¦åˆäºå•ç‚¹ï¼Œä»»ä½•éœ€æ±‚å˜æ›´éƒ½å¯èƒ½æ³¢åŠæ ¸å¿ƒè·¯å¾„ã€‚
- å»ºè®®ä¿®å¤ï¼šæ‹†æˆ providerResolverã€upstreamAdapterã€sessionRuntimeã€errorMapperã€‚
- ä¼˜å…ˆçº§ï¼šP1

## ğŸŸ¡ ä¸­å±é—®é¢˜ï¼ˆMediumï¼‰
### [A5-M-001] ä¸šåŠ¡æœåŠ¡ç›´æ¥è€¦åˆ IPC å¥‘çº¦
- æ–‡ä»¶ï¼š`apps/desktop/main/src/services/documents/documentService.ts`
- è¡Œå·/èŒƒå›´ï¼šL5-L8
- é—®é¢˜ç±»å‹ï¼šæ¨¡å—è¾¹ç•Œè¿å
- æè¿°ï¼šmain ä¸šåŠ¡ service ç›´æ¥ä¾èµ– `ipc-generated` çš„ `IpcError/IpcErrorCode`ã€‚
- ä»£ç ç‰‡æ®µï¼š
```ts
import type {
  IpcError,
  IpcErrorCode,
} from "../../../../../../packages/shared/types/ipc-generated";
```
- é£é™©ï¼šé¢†åŸŸæœåŠ¡è¢«ä¼ è¾“åè®®ç»‘æ­»ï¼Œéš¾å¤ç”¨åˆ°é IPC åœºæ™¯ã€‚
- å»ºè®®ä¿®å¤ï¼šservice å±‚å®šä¹‰é¢†åŸŸé”™è¯¯ï¼ŒIPC å±‚åšæ˜ å°„ã€‚
- ä¼˜å…ˆçº§ï¼šP2

### [A5-M-002] è·¨å±‚æ·±ç›¸å¯¹è·¯å¾„å¯¼å…¥æ³›åŒ–
- æ–‡ä»¶ï¼š`apps/desktop/renderer/src/lib/ipcClient.ts`
- è¡Œå·/èŒƒå›´ï¼šL5
- é—®é¢˜ç±»å‹ï¼šç›´æ¥ä¾èµ–æ›¿ä»£æ¥å£
- æè¿°ï¼šè·¨å±‚å…±äº«å¥‘çº¦é€šè¿‡ `../../../../../packages/shared/...` ç›´è¿ï¼Œå‘½ä¸­ 77 ä¸ªéæµ‹è¯•æ–‡ä»¶ã€‚
- ä»£ç ç‰‡æ®µï¼š
```ts
import type {
  IpcChannel,
  IpcInvokeResult,
  IpcRequest,
} from "../../../../../packages/shared/types/ipc-generated";
```
- é£é™©ï¼šç›®å½•ç»“æ„å¾®è°ƒè§¦å‘å¤§é¢ç§¯ç ´åï¼Œæ¨¡å—è¾¹ç•Œæ²»ç†å¼±åŒ–ã€‚
- å»ºè®®ä¿®å¤ï¼šæä¾›ç»Ÿä¸€ workspace aliasï¼ˆå¦‚ `@creonow/shared/*`ï¼‰ã€‚
- ä¼˜å…ˆçº§ï¼šP2

## ğŸ”µ ä½å±é—®é¢˜ï¼ˆLowï¼‰
### [A5-L-001] ç›®å½•å‘½åé£æ ¼æ¼‚ç§»
- æ–‡ä»¶ï¼š`apps/desktop/renderer/src/components/layout/AppShell.tsx`
- è¡Œå·/èŒƒå›´ï¼šL9, L24
- é—®é¢˜ç±»å‹ï¼šé£æ ¼æ¼‚ç§»/å‘½åä¸ä¸€è‡´
- æè¿°ï¼šåŒçº§ features ç›®å½•æ··ç”¨ camelCaseã€kebab-case ä¸å…¨å°å†™ã€‚
- ä»£ç ç‰‡æ®µï¼š
```ts
import { CommandPalette } from "../../features/commandPalette/CommandPalette";
import { SettingsDialog } from "../../features/settings-dialog/SettingsDialog";
import { InfoPanel, QualityPanel } from "../../features/rightpanel";
```
- é£é™©ï¼šå®šä½ä¸çº¦å®šæˆæœ¬ä¸Šå‡ï¼Œè„šæ‰‹æ¶/lint è§„åˆ™éš¾ç»Ÿä¸€ã€‚
- å»ºè®®ä¿®å¤ï¼šç»Ÿä¸€ç›®å½•å‘½åçº¦å®šå¹¶å¯ç”¨ lint çº¦æŸã€‚
- ä¼˜å…ˆçº§ï¼šP3

### [A5-L-002] æºç  BOM å¤´ä¸ä¸€è‡´
- æ–‡ä»¶ï¼š`apps/desktop/renderer/src/features/ai/AiPanel.tsx`
- è¡Œå·/èŒƒå›´ï¼šL1
- é—®é¢˜ç±»å‹ï¼šé£æ ¼æ¼‚ç§»ï¼ˆç¼–ç å¤´ä¸ä¸€è‡´ï¼‰
- æè¿°ï¼šæ£€æµ‹åˆ° UTF-8 BOMï¼Œå‘½ä¸­ 9 ä¸ªæºç æ–‡ä»¶ã€‚
- ä»£ç ç‰‡æ®µï¼š
```text
AiPanel.tsx  ef bb bf
aiService.ts ef bb bf
```
- é£é™©ï¼šå¯èƒ½å¼•å‘é¦–å­—ç¬¦è§£æé—®é¢˜ä¸è·¨å¹³å° diff å™ªéŸ³ã€‚
- å»ºè®®ä¿®å¤ï¼šç»Ÿä¸€ UTF-8 æ—  BOM å¹¶åœ¨æ ¼å¼åŒ–å™¨ä¸­å¼ºåˆ¶ã€‚
- ä¼˜å…ˆçº§ï¼šP3

## æ¨¡å¼ç»Ÿè®¡
- å¾ªç¯ä¾èµ–ï¼š2
- God Object / å•ä½“å›å½’ï¼š2
- æ¨¡å—è¾¹ç•Œ/åˆ†å±‚è€¦åˆï¼š2
- é£æ ¼æ¼‚ç§»/å‘½åä¸€è‡´æ€§ï¼š2

# CN 修复优先级排序（P0 → P3）

## P0（立即修复）
| 序号 | 关联编号 | 修复项 | 预估工作量 |
| --- | --- | --- | --- |
| 1 | A3-C-001 | 修复空内容请求伪造 `queued` 成功响应（改为真实 no-op/错误语义） | M |
| 2 | A5-C-001 | 打断 Context 装配链路循环依赖（抽离类型与工具层） | L |
| 3 | A4-H-002 | 为 IPC 增加调用方身份与来源 ACL 鉴权 | L |
| 4 | A4-H-001 | 启用 Electron sandbox 安全默认并回归验证 | M |
| 5 | A6-H-003 | KG 面板异步写入改为结果校验 + allSettled 一致性处理 | M |
| 6 | A6-H-001 | 窗口加载 Promise 统一兜底并建立错误上报链 | S |
| 7 | A7-C-001 | 拆分 `createDocumentService`（1743 行） | XL |
| 8 | A7-C-002 | 拆分 `createAiService`（1460 行） | XL |
| 9 | A7-C-003 | 拆分 `createKnowledgeGraphService`（1378 行） | XL |
| 10 | A7-C-004 | 拆分 `registerContextIpcHandlers`（953 行） | XL |
| 11 | A7-C-005 | 拆分 `FileTreePanel`（864 行） | L |
| 12 | A7-C-006 | 拆分 `AiPanel`（1254 行） | XL |

## P1（高优先级）
| 序号 | 关联编号 | 修复项 | 预估工作量 |
| --- | --- | --- | --- |
| 1 | A2-H-001 | context 组装异常可观测化，禁用静默吞错 | M |
| 2 | A2-H-002 | metadata 解析失败禁止清空回写 | M |
| 3 | A2-H-003 | KG Panel 解析失败链路改为 fail-fast + 诊断 | M |
| 4 | A2-H-004 | skill 目录读取失败改为结构化错误返回 | S |
| 5 | A3-H-001 | skillScheduler 聚合 response/completion 并保留异常上下文 | M |
| 6 | A3-H-002 | KG metrics 拆分 succeeded/failed/completed 计数 | S |
| 7 | A5-H-001 | RightPanel/AiPanel 循环依赖拆解（抽 context） | M |
| 8 | A5-H-002 | DocumentService 按职责拆分（架构层） | XL |
| 9 | A5-H-003 | AIService 按职责拆分（架构层） | XL |
| 10 | A6-H-002 | `app.whenReady()` 顶层初始化链统一 catch | S |
| 11 | A7-H-007 | 共享契约导入改 alias，消除深层相对路径（main） | M |
| 12 | A7-H-008 | 共享契约导入改 alias，消除深层相对路径（renderer） | M |
| 13 | A7-H-009 | IPC payload 上限硬编码迁移到集中配置 | S |
| 14 | A7-H-010 | AI 超时/重试/token 预算集中配置治理 | M |
| 15 | A7-H-011 | KG 查询超时常量配置化 | S |
| 16 | A7-H-012 | RAG `maxTokens` 配置化并与预算中心对齐 | S |
| 17 | A1-H-001 | Settings 账户入口未实现逻辑下线或禁用 | S |
| 18 | A1-H-002 | VersionListItem 类型定义收敛单源 | S |
| 19 | A1-H-003 | judge:model:ensure 共享状态机实现收敛 | M |
| 20 | A1-H-004 | Version wordChange 占位值改真实计算或下线 | M |

## P2（中优先级）
| 序号 | 关联编号 | 修复项 | 预估工作量 |
| --- | --- | --- | --- |
| 1 | A1-M-001 | 移除生产组件中的 demo 控制参数（AiInlineConfirm） | S |
| 2 | A1-M-002 | 移除生产组件中的重试成功开关（AiErrorCard） | S |
| 3 | A1-M-003 | 压缩 barrel 模板注释，示例迁移 Storybook | S |
| 4 | A1-M-004 | 去除无收益一行包装函数 | S |
| 5 | A2-M-001 | Context fetcher 降级 warning 增加错误摘要 ID | S |
| 6 | A2-M-002 | executionId/runId 双字段兼容治理（弃用策略） | M |
| 7 | A2-M-003 | id/skillId 双字段兼容治理（弃用策略） | M |
| 8 | A2-M-004 | 删除 ping handler 不可达 catch | S |
| 9 | A3-M-001 | 固定 sleep 异步测试改条件等待 | M |
| 10 | A3-M-002 | story 测试增加行为断言（非存在性断言） | S |
| 11 | A4-M-001 | debug IPC 通道生产禁用/加门禁 | S |
| 12 | A5-M-001 | service 领域错误与 IPC 错误映射解耦 | M |
| 13 | A5-M-002 | 全库深层相对路径导入收敛到统一 alias | L |
| 14 | A6-M-001 | MemoryPanel 加强异常处理并闭环 UI 错误态 | S |
| 15 | A6-M-002 | kgStore 引入 requestId 防止项目切换竞态 | M |
| 16 | A6-M-003 | searchStore 引入 abort/request stamp 防竞态覆盖 | M |
| 17 | A6-M-004 | skillScheduler 完整错误传播与日志上下文 | S |
| 18 | A7-M-013 | main 入口 import 扇入治理与注册器拆分 | M |
| 19 | A7-M-014 | AppShell 扇入治理（facade 化） | M |
| 20 | A7-M-015 | integration test 去 renderer 内部依赖 | M |
| 21 | A7-M-016 | integration test 去 main 内部实现耦合 | M |

## P3（Backlog）
| 序号 | 关联编号 | 修复项 | 预估工作量 |
| --- | --- | --- | --- |
| 1 | A1-L-001 | 清理未使用占位参数 `onScrollSync` | S |
| 2 | A1-L-002 | 下线 deprecated 面板双轨样式路径 | S |
| 3 | A2-L-001 | AppShell 默认值降级路径增加可观测诊断 | S |
| 4 | A2-L-002 | contextRules 非法输入与空规则语义分离 | S |
| 5 | A3-L-001 | 测试断言从布尔判定升级为精确断言 | S |
| 6 | A4-L-001 | DocumentService 错误处理风格统一 | M |
| 7 | A4-L-002 | 技术栈文档与依赖清单治理同步 | S |
| 8 | A5-L-001 | features 命名规范统一并引入 lint 规则 | M |
| 9 | A5-L-002 | BOM 清理并强制 UTF-8 无 BOM | S |
| 10 | A6-L-001 | preload IPC listener 生命周期释放机制 | S |
| 11 | A6-L-002 | popover 关闭定时器清理 | S |
| 12 | A7-L-017 | Settings 账户流程 TODO 任务化闭环 | S |
| 13 | A7-L-018 | Version word diff TODO 闭环 | S |
| 14 | A7-L-019 | Windows 键盘事件 TODO 闭环 | M |

## 备注
- 本清单按风险和治理收益排序，优先执行 P0/P1。
- A7 的 1631 项命中包含模式统计型问题；若进入治理实施，建议先从 P0/P1 对应的架构拆分与配置集中化开始，随后批量清理 P2/P3。

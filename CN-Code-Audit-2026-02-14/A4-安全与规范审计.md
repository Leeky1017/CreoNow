# [A4安全与规范审计员] 审计报告

## 审计摘要
- 扫描文件数：664
- 发现问题总数：5
- 严重（Critical）：0 | 高危（High）：2 | 中危（Medium）：1 | 低危（Low）：2

## 🔴 严重问题（Critical）
- 本轮未发现 Critical 级别问题。

## 🟠 高危问题（High）
### [A4-H-001] Electron Sandbox 默认关闭
- 文件：`apps/desktop/main/src/index.ts`
- 行号/范围：L104-L108
- 问题类型：不安全默认配置
- 描述：主窗口 `webPreferences.sandbox` 显式为 `false`。
- 代码片段：
```ts
webPreferences: {
  preload,
  contextIsolation: true,
  nodeIntegration: false,
  sandbox: false,
},
```
- 风险：渲染层出现 XSS/依赖链污染时，主进程边界保护减弱。
- 建议修复：默认启用 `sandbox: true`，仅对必要窗口做最小例外并补充回归测试。
- 优先级：P1

### [A4-H-002] IPC 调用方身份/来源未鉴权
- 文件：`apps/desktop/main/src/ipc/runtime-validation.ts`
- 行号/范围：L403-L417
- 问题类型：权限检查缺失（IPC）
- 描述：运行时校验覆盖 schema/envelope，但未校验 `event.senderFrame.url`、`webContents.id`、会话角色等调用方权限；preload 允许全部通道透传。
- 代码片段：
```ts
return async (event, payload): Promise<IpcResponse<unknown>> => {
  ...
  const raw = await runWithTimeout(
    async () => await Promise.resolve(args.handler(event, requestPayload)),
    args.timeoutMs,
  );
```
- 风险：渲染层被注入或越权页面出现时，可能直接调用高权限 IPC 通道。
- 建议修复：增加统一调用方鉴权（来源白名单、窗口/会话标识、按通道 ACL），默认拒绝。
- 优先级：P1

## 🟡 中危问题（Medium）
### [A4-M-001] 调试通道在常规路径暴露
- 文件：`apps/desktop/main/src/index.ts`
- 行号/范围：L186-L204
- 问题类型：敏感信息泄露面
- 描述：`db:debug:tablenames` 常规注册且可被公开 IPC 通道调用。
- 代码片段：
```ts
guardedIpcMain.handle(
  "db:debug:tablenames",
  async (): Promise<IpcResponse<{ tableNames: string[] }>> => {
    ...
    const rows = deps.db.prepare("SELECT name FROM sqlite_master ...").all();
```
- 风险：泄露数据库结构元信息，便于后续针对性枚举。
- 建议修复：仅 dev/e2e 注册，或增加显式 debug 权限门禁。
- 优先级：P2

## 🔵 低危问题（Low）
### [A4-L-001] 错误处理风格混杂
- 文件：`apps/desktop/main/src/services/documents/documentService.ts`
- 行号/范围：L904-L905
- 问题类型：规范漂移
- 描述：同一服务混用 `throw new Error("NOT_FOUND")` 与 `ipcError(...)` 返回式错误。
- 代码片段：
```ts
if (!target) {
  throw new Error("NOT_FOUND");
}
...
const code =
  error instanceof Error && error.message === "NOT_FOUND"
    ? ("NOT_FOUND" as const)
    : ("DB_ERROR" as const);
return ipcError(code, ...);
```
- 风险：维护成本上升，错误码映射易漂移。
- 建议修复：统一为显式 Result/Err 返回。
- 优先级：P3

### [A4-L-002] 技术栈文档与依赖清单疑似漂移
- 文件：`apps/desktop/package.json`
- 行号/范围：L44, L46
- 问题类型：规范漂移（疑似未经批准新依赖痕迹）
- 描述：`docx`、`pdfkit` 在依赖中存在，但锁定技术栈文档未明确对应项。
- 代码片段：
```json
"docx": "^9.5.1",
"pdfkit": "^0.17.2",
```
- 风险：治理层已批准清单与实际依赖不一致，审批基线失真。
- 建议修复：补齐 RFC/批准记录并同步技术栈文档，或补充非核心允许依赖清单。
- 优先级：P3

## 模式统计
- 输入/权限校验缺失：1
- 不安全默认配置：1
- 信息泄露面：1
- 错误处理风格混杂：1
- 未经批准新依赖痕迹（疑似）：1

# [A7可维护性审计员] 审计报告

## 审计摘要
- 扫描文件数：664
- 发现问题总数：1631（规则命中，含同文件多项）
- 严重（Critical）：223 | 高危（High）：328 | 中危（Medium）：1076 | 低危（Low）：4

## 🔴 严重问题（Critical）
### [A7-C-001] DocumentService 超长函数与高复杂度
- 文件：`apps/desktop/main/src/services/documents/documentService.ts`
- 行号/范围：L863
- 问题类型：文件/函数规模超标、认知复杂度过高
- 描述：`createDocumentService` 长度约 1743 行，复杂度估算 236。
- 代码片段：
```ts
export function createDocumentService(args: {
```
- 风险：单函数承载过多职责，改动回归面极大。
- 建议修复：按快照、分支、合并、容量治理拆分子服务。
- 优先级：P0

### [A7-C-002] AiService 超长函数与高复杂度
- 文件：`apps/desktop/main/src/services/ai/aiService.ts`
- 行号/范围：L981
- 问题类型：文件/函数规模超标、认知复杂度过高
- 描述：`createAiService` 长度约 1460 行，复杂度估算 234。
- 代码片段：
```ts
export function createAiService(deps: {
```
- 风险：AI 请求链路耦合严重，策略改动易引发跨场景回归。
- 建议修复：拆为 provider 路由、重试/限流、会话预算、技能执行四层。
- 优先级：P0

### [A7-C-003] KGService 超长函数与高复杂度
- 文件：`apps/desktop/main/src/services/kg/kgService.ts`
- 行号/范围：L784
- 问题类型：文件/函数规模超标、认知复杂度过高
- 描述：`createKnowledgeGraphService` 长度约 1378 行，复杂度估算 269。
- 代码片段：
```ts
export function createKnowledgeGraphService(args: {
```
- 风险：图查询/写入/约束逻辑混杂，扩展与性能治理风险高。
- 建议修复：按 `query/write/validation/context-injection` 分模块下沉。
- 优先级：P0

### [A7-C-004] Context IPC 注册函数过重
- 文件：`apps/desktop/main/src/ipc/context.ts`
- 行号/范围：L138
- 问题类型：函数规模超标、分层职责聚集
- 描述：`registerContextIpcHandlers` 长度约 953 行，复杂度估算 102。
- 代码片段：
```ts
export function registerContextIpcHandlers(deps: {
```
- 风险：IPC 注册层承载业务逻辑，接口变更容易破坏契约一致性。
- 建议修复：IPC 层仅保留校验与路由，业务逻辑迁移 service。
- 优先级：P0

### [A7-C-005] FileTreePanel 上帝组件化
- 文件：`apps/desktop/renderer/src/features/files/FileTreePanel.tsx`
- 行号/范围：L280
- 问题类型：组件规模超标、认知复杂度过高
- 描述：`FileTreePanel` 长度约 864 行，复杂度估算 114。
- 代码片段：
```tsx
export function FileTreePanel(props: FileTreePanelProps): JSX.Element {
```
- 风险：状态与交互耦合，局部改动易引发链式回归。
- 建议修复：拆分节点渲染、拖拽、菜单、筛选状态子组件/Hook。
- 优先级：P0

### [A7-C-006] AiPanel 上帝组件化
- 文件：`apps/desktop/renderer/src/features/ai/AiPanel.tsx`
- 行号/范围：L343
- 问题类型：组件规模超标、认知复杂度过高
- 描述：`AiPanel` 长度约 1254 行，复杂度估算 172。
- 代码片段：
```tsx
export function AiPanel(): JSX.Element {
```
- 风险：AI 面板改动风险高，测试脆弱性上升。
- 建议修复：拆分对话流、候选管理、错误态、技能面板容器。
- 优先级：P0

## 🟠 高危问题（High）
### [A7-H-007] ProjectService 深层相对路径依赖
- 文件：`apps/desktop/main/src/services/projects/projectService.ts`
- 行号/范围：L10
- 问题类型：import 依赖图不健康（高耦合）
- 描述：存在 6 层相对路径依赖共享包。
- 代码片段：
```ts
} from "../../../../../../packages/shared/types/ipc-generated";
```
- 风险：目录调整触发大面积编译失败。
- 建议修复：引入 `tsconfig paths` 别名（如 `@shared/*`）。
- 优先级：P1

### [A7-H-008] aiStore 深层相对路径依赖
- 文件：`apps/desktop/renderer/src/stores/aiStore.ts`
- 行号/范围：L10
- 问题类型：import 依赖图不健康（高耦合）
- 描述：5 层相对路径穿透到共享包。
- 代码片段：
```ts
} from "../../../../../packages/shared/types/ipc-generated";
```
- 风险：跨层耦合显式化，维护成本高。
- 建议修复：renderer/preload/main 统一切换 alias。
- 优先级：P1

### [A7-H-009] IPC 载荷上限硬编码
- 文件：`apps/desktop/preload/src/ipcGateway.ts`
- 行号/范围：L10
- 问题类型：硬编码与魔法值（协议阈值）
- 描述：IPC 载荷上限写死 `10 * 1024 * 1024`。
- 代码片段：
```ts
export const MAX_IPC_PAYLOAD_BYTES = 10 * 1024 * 1024;
```
- 风险：不同平台/场景无法按环境调优阈值。
- 建议修复：迁移到集中配置并支持环境覆盖。
- 优先级：P1

### [A7-H-010] AI 关键阈值散落硬编码
- 文件：`apps/desktop/main/src/services/ai/aiService.ts`
- 行号/范围：L132, L136, L139
- 问题类型：硬编码与魔法值（超时/重试/token）
- 描述：多组关键阈值散落定义。
- 代码片段：
```ts
const DEFAULT_TIMEOUT_MS = 10_000;
const DEFAULT_RETRY_BACKOFF_MS = [1_000, 2_000, 4_000] as const;
const DEFAULT_SESSION_TOKEN_BUDGET = 200_000;
```
- 风险：跨模块预算口径不一致，线上调参困难。
- 建议修复：抽出 `runtime-governance-config` 单一配置源。
- 优先级：P1

### [A7-H-011] KG 查询超时硬编码
- 文件：`apps/desktop/main/src/services/kg/kgService.ts`
- 行号/范围：L49
- 问题类型：硬编码与魔法值（超时）
- 描述：查询超时常量固定为 `2_000ms`。
- 代码片段：
```ts
const DEFAULT_QUERY_TIMEOUT_MS = 2_000;
```
- 风险：大图或低配环境误报超时概率高。
- 建议修复：按项目规模/环境分层配置。
- 优先级：P1

### [A7-H-012] RAG maxTokens 写死
- 文件：`apps/desktop/main/src/ipc/rag.ts`
- 行号/范围：L37
- 问题类型：硬编码与魔法值（token 上限）
- 描述：RAG `maxTokens` 默认值写死为 `1500`。
- 代码片段：
```ts
maxTokens: 1500,
```
- 风险：与其他 token budget 口径偏移，检索截断行为不可预测。
- 建议修复：统一接入 token budget 配置中心。
- 优先级：P1

## 🟡 中危问题（Medium）
### [A7-M-013] 主入口 import 扇入偏高
- 文件：`apps/desktop/main/src/index.ts`
- 行号/范围：L1-L25, L127
- 问题类型：可维护性退化（高扇入）
- 描述：`import` 数量 30，`registerIpcHandlers` 长度 209 行。
- 代码片段：
```ts
import { registerAiIpcHandlers } from "./ipc/ai";
...
function registerIpcHandlers(deps: {
```
- 风险：主入口变更冲突率高。
- 建议修复：按域拆分 `registerIpcHandlers*` 子装配器。
- 优先级：P2

### [A7-M-014] AppShell import 扇入偏高
- 文件：`apps/desktop/renderer/src/components/layout/AppShell.tsx`
- 行号/范围：L1
- 问题类型：可维护性退化（高扇入）
- 描述：`import` 数量 31。
- 代码片段：
```tsx
import React from "react";
```
- 风险：布局层对功能模块耦合过重。
- 建议修复：引入 feature facade，减少直接依赖数量。
- 优先级：P2

### [A7-M-015] Integration Test 边界穿透 renderer store
- 文件：`apps/desktop/tests/integration/project-switch.autosave.test.ts`
- 行号/范围：L3
- 问题类型：import 依赖图不健康（测试层边界穿透）
- 描述：integration test 直接引用 renderer 内部 store。
- 代码片段：
```ts
import { createProjectStore } from "../../renderer/src/stores/projectStore";
```
- 风险：重构时测试雪崩。
- 建议修复：通过公共 test harness/公开 API 注入依赖。
- 优先级：P2

### [A7-M-016] Integration Test 边界穿透 main service
- 文件：`apps/desktop/tests/integration/ai-skill-context-integration.test.ts`
- 行号/范围：L6-L8
- 问题类型：import 依赖图不健康（测试层边界穿透）
- 描述：integration test 直接引用 main 内部服务实现。
- 代码片段：
```ts
import type { Logger } from "../../main/src/logging/logger";
import { createAiService } from "../../main/src/services/ai/aiService";
```
- 风险：测试与内部实现强绑定，降低模块替换弹性。
- 建议修复：优先走 IPC 契约层或 service factory 抽象。
- 优先级：P2

## 🔵 低危问题（Low）
### [A7-L-017] 账户流程 TODO 未闭环
- 文件：`apps/desktop/renderer/src/features/settings-dialog/SettingsDialog.tsx`
- 行号/范围：L198, L201
- 问题类型：TODO/FIXME/HACK
- 描述：账户升级/删除流程留空。
- 代码片段：
```tsx
// TODO: Implement upgrade flow when account system is ready
// TODO: Implement delete account when account system is ready
```
- 风险：功能认知偏差与需求债务累积。
- 建议修复：关联 issue 并补充验收条件与下线计划。
- 优先级：P3

### [A7-L-018] Version 词数变化 TODO 未闭环
- 文件：`apps/desktop/renderer/src/features/version-history/VersionHistoryContainer.tsx`
- 行号/范围：L160
- 问题类型：TODO/FIXME/HACK
- 描述：词数变化仍为占位实现。
- 代码片段：
```ts
wordChange: { type: "none", count: 0 }, // TODO: calculate actual word diff
```
- 风险：用户侧指标不准确。
- 建议修复：补齐 diff 计算并增加回归测试。
- 优先级：P3

### [A7-L-019] Windows 键盘事件 TODO 未闭环
- 文件：`apps/desktop/tests/e2e/command-palette.spec.ts`
- 行号/范围：L272
- 问题类型：TODO/FIXME/HACK
- 描述：Windows 键盘事件时序问题未处理。
- 代码片段：
```ts
// TODO: Investigate Windows-specific keyboard event handling in Electron/Playwright
```
- 风险：跨平台 E2E 可信度下降。
- 建议修复：建立平台差异基线并收敛为可重现最小用例。
- 优先级：P3

## 模式统计
- 超长文件（>400 行）：108
- 超长函数（>60 行）：571
- 高认知复杂度（>=25）：127
- 深层相对路径 import（`../../../` 及以上）：818
- 高 import 扇入文件（>25 imports）：3
- `TODO/FIXME/HACK`：4
- 疑似硬编码阈值/预算常量：85

# CN 全库反模式审计总报告

## 审计范围与时间
- 审计对象：`apps/` 下全部源码（重点 `.ts/.tsx/.css/.json`）
- 排除目录：`node_modules/`、`dist/`、`build/`
- 审计模式：A1-A7 七个专项子代理并行只读审计
- 审计时间（CST）：2026-02-14 00:40 - 2026-02-14 01:10
- 代码变更策略：仅产出审计文档，不修改业务代码

## 各子代理汇总统计
| 子代理 | 领域 | 扫描文件数 | 问题总数 | Critical | High | Medium | Low |
| --- | --- | ---: | ---: | ---: | ---: | ---: | ---: |
| A1 | 代码膨胀 | 666 | 10 | 0 | 4 | 4 | 2 |
| A2 | 行为偏差 | 694 | 10 | 0 | 4 | 4 | 2 |
| A3 | 质量陷阱 | 664 | 6 | 1 | 2 | 2 | 1 |
| A4 | 安全与规范 | 664 | 5 | 0 | 2 | 1 | 2 |
| A5 | 架构合规 | 661 | 8 | 1 | 3 | 2 | 2 |
| A6 | 健壮性 | 661 | 9 | 0 | 3 | 4 | 2 |
| A7 | 可维护性 | 664 | 1631 | 223 | 328 | 1076 | 4 |
| **总计** |  |  | **1679** | **225** | **346** | **1093** | **15** |

> 说明：A7 包含规则命中型统计（同文件可多命中），因此总量显著高于其余代理。

## Top 10 最紧急问题（跨子代理）
1. **A3-C-001**：空内容请求伪造 `queued` 成功响应（`kgRecognitionRuntime`）
2. **A5-C-001**：Context 装配与 fetcher 形成循环依赖闭环
3. **A4-H-002**：IPC 缺少调用方身份/来源鉴权（高权限通道可被越权调用）
4. **A4-H-001**：Electron `sandbox: false` 不安全默认
5. **A6-H-003**：KG 面板异步写入不校验结果，前后端状态可分叉
6. **A6-H-001**：窗口加载 Promise 未兜底，失败链断裂
7. **A2-H-001**：context 组装异常被静默吞掉，行为降级不可观测
8. **A2-H-002**：metadata 解析失败即清空回写，存在隐性数据丢失风险
9. **A7-C-001**：`createDocumentService` 超长高复杂度（1743 行）
10. **A7-C-002**：`createAiService` 超长高复杂度（1460 行）

## 模块维度问题热力图
统计口径：按 A1-A7 明细问题（含 A7 已列明 19 项）映射到主模块。

| 模块 | 问题数 | 热度 |
| --- | ---: | --- |
| Workbench | 15 | 🔥 高 |
| KG | 12 | 🔥 高 |
| AI Service | 12 | 🔥 高 |
| IPC | 8 | 🟠 中高 |
| Skill | 6 | 🟠 中 |
| Document | 5 | 🟠 中 |
| VC | 4 | 🟡 中低 |
| Context | 2 | 🟡 中低 |
| Search | 2 | 🟡 中低 |
| Memory | 1 | 🟢 低 |

## 建议修复 Sprint 排期（3 批次）
### 批次 1（P0，立即）
- 修复错误语义与安全边界：A3-C-001、A5-C-001、A4-H-001、A4-H-002
- 稳定关键异步链路：A6-H-001、A6-H-002、A6-H-003
- 启动核心超大函数拆分设计：A7-C-001、A7-C-002、A7-C-003

### 批次 2（P1，高优）
- 收敛 fallback/降级链：A2-H-001~A2-H-004
- 打散 God Object 与循环依赖：A5-H-001~A5-H-003
- 清理硬编码阈值与深层相对路径：A7-H-007~A7-H-012

### 批次 3（P2-P3，治理债务）
- 修复测试可信度问题：A3-M-001、A3-M-002、A3-L-001
- 收敛风格漂移与僵尸路径：A1-M/L、A4-L、A5-L
- 执行可维护性系统治理：A7-M/L + A7 模式统计项（超长函数、复杂度、import 图）

## 交付物清单
- `CN-Code-Audit-2026-02-14/A1-代码膨胀审计.md`
- `CN-Code-Audit-2026-02-14/A2-行为偏差审计.md`
- `CN-Code-Audit-2026-02-14/A3-质量陷阱审计.md`
- `CN-Code-Audit-2026-02-14/A4-安全与规范审计.md`
- `CN-Code-Audit-2026-02-14/A5-架构合规审计.md`
- `CN-Code-Audit-2026-02-14/A6-健壮性审计.md`
- `CN-Code-Audit-2026-02-14/A7-可维护性审计.md`
- `CN-Code-Audit-2026-02-14/99-修复优先级排序.md`

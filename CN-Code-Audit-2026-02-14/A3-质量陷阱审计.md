# [A3质量陷阱审计员] 审计报告

## 审计摘要
- 扫描文件数：664
- 发现问题总数：6
- 严重（Critical）：1 | 高危（High）：2 | 中危（Medium）：2 | 低危（Low）：1

## 🔴 严重问题（Critical）
### [A3-C-001] 空内容时伪造“已排队任务”响应
- 文件：`apps/desktop/main/src/services/kg/kgRecognitionRuntime.ts`
- 行号/范围：L470-L478
- 问题类型：静默失败/表面正确（伪造输出）
- 描述：`contentText` 为空时直接返回 `ok: true` + 随机 `taskId` + `status: "queued"`，但实际未入队。
- 代码片段：
```ts
if (normalizedContentText.length === 0) {
  return {
    ok: true,
    data: {
      taskId: randomUUID(),
      status: "queued",
      queuePosition: 0,
    },
  };
}
```
- 风险：调用方误以为任务存在，后续取消/追踪失败，形成表面成功。
- 建议修复：返回 `status: "skipped"` 或 `ok: false` + 结构化原因；禁止生成不可追踪 taskId。
- 优先级：P0

## 🟠 高危问题（High）
### [A3-H-001] Scheduler 异步错误上下文丢失
- 文件：`apps/desktop/main/src/services/skills/skillScheduler.ts`
- 行号/范围：L260-L278
- 问题类型：静默失败/异步错误吞并
- 描述：`response` 与 `completion` 分离处理，`completion.catch(() => ...)` 丢弃错误细节。
- 代码片段：
```ts
void started.response
  .then((result) => { task.resolveResult(result); })
  .catch((error) => { task.resolveResult(ipcError(...)); });

void started.completion
  .then((terminal) => { finalizeTask(sessionKey, task, terminal); })
  .catch(() => { finalizeTask(sessionKey, task, "failed"); });
```
- 风险：排障信息丢失；响应结果与队列终态出现不一致（疑似）。
- 建议修复：聚合 `response/completion` 结果；catch 保留错误上下文并上报。
- 优先级：P1

### [A3-H-002] 失败任务被计入 completed
- 文件：`apps/desktop/main/src/services/kg/kgRecognitionRuntime.ts`
- 行号/范围：L424-L437, L645-L660
- 问题类型：表面正确（失败也计 completed）
- 描述：`processTask` 失败后 finally 无条件 `metrics.completed += 1`（非取消即+1）。
- 代码片段：
```ts
void processTask(next)
  .catch((error) => { args.logger.error(...); })
  .finally(() => {
    running.delete(next.taskId);
    if (!metrics.canceledTaskIds.includes(next.taskId)) {
      metrics.completed += 1;
      metrics.completionOrder.push(next.taskId);
    }
    pump();
  });
```
- 风险：监控把失败当完成，健康度和容量判断失真。
- 建议修复：拆分 `succeeded/failed/completed` 计数并对外暴露失败数。
- 优先级：P1

## 🟡 中危问题（Medium）
### [A3-M-001] 固定 sleep 驱动异步测试
- 文件：`apps/desktop/tests/integration/kg/recognition-query-failure-degrade.test.ts`
- 行号/范围：L46-L48
- 问题类型：虚假测试覆盖率（Happy path + 时间等待）
- 描述：依赖固定 `setTimeout(80)` 等待异步完成，而非基于事件/条件收敛。
- 代码片段：
```ts
await new Promise((resolve) => {
  setTimeout(resolve, 80);
});
```
- 风险：对机器负载敏感，慢机/并发下偶发红绿，掩盖真实竞态。
- 建议修复：改为条件等待（事件、状态轮询、`waitFor`）。
- 优先级：P2

### [A3-M-002] Story 测试仅做存在性断言
- 文件：`apps/desktop/renderer/src/features/ai/AiPanel.stories.test.ts`
- 行号/范围：L6-L10
- 问题类型：虚假测试覆盖率（浅层断言）
- 描述：仅断言 story 导出存在，不验证渲染行为、交互或状态。
- 代码片段：
```ts
expect(stories.Default).toBeDefined();
expect(stories.EmptyState).toBeDefined();
expect(stories.GeneratingState).toBeDefined();
expect(stories.ErrorState).toBeDefined();
```
- 风险：覆盖率上升但行为回归无法被拦截。
- 建议修复：增加关键 story 的渲染/交互断言。
- 优先级：P2

## 🔵 低危问题（Low）
### [A3-L-001] 低信息密度布尔断言
- 文件：`apps/desktop/tests/unit/kg/recognition-silent-degrade.test.ts`
- 行号/范围：L40-L43
- 问题类型：虚假测试覆盖率（浅层布尔断言）
- 描述：使用 `assert.equal(errorEvents.length > 0, true)`，失败诊断弱。
- 代码片段：
```ts
const errorEvents = harness.logs.error.filter(
  (event) => event.event === "kg_recognition_unavailable",
);
assert.equal(errorEvents.length > 0, true);
```
- 风险：定位失败原因困难，边界条件易被掩盖。
- 建议修复：改为精确断言（数量和关键字段）。
- 优先级：P3

## 模式统计
- 伪造/表面成功返回：1
- 吞错或丢失错误上下文：1
- 完成统计与失败混算：1
- 固定 `setTimeout` 驱动异步测试：19（命中）
- 浅层存在性断言（`toBeDefined/toBeTruthy`）：18（命中）
- 高频 mock 测试位点（`vi.mock/jest.mock`）：161（36 个测试文件，需继续抽检）

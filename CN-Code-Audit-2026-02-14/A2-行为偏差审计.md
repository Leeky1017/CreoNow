# [A2è¡Œä¸ºåå·®å®¡è®¡å‘˜] å®¡è®¡æŠ¥å‘Š

## å®¡è®¡æ‘˜è¦
- æ‰«ææ–‡ä»¶æ•°ï¼š694
- å‘ç°é—®é¢˜æ€»æ•°ï¼š10
- ä¸¥é‡ï¼ˆCriticalï¼‰ï¼š0 | é«˜å±ï¼ˆHighï¼‰ï¼š4 | ä¸­å±ï¼ˆMediumï¼‰ï¼š4 | ä½å±ï¼ˆLowï¼‰ï¼š2

## ğŸ”´ ä¸¥é‡é—®é¢˜ï¼ˆCriticalï¼‰
- æœ¬è½®æœªå‘ç° Critical çº§åˆ«é—®é¢˜ã€‚

## ğŸŸ  é«˜å±é—®é¢˜ï¼ˆHighï¼‰
### [A2-H-001] Context ç»„è£…å¼‚å¸¸è¢«é™é»˜åæ‰
- æ–‡ä»¶ï¼š`apps/desktop/main/src/services/skills/skillExecutor.ts`
- è¡Œå·/èŒƒå›´ï¼šL250-L261
- é—®é¢˜ç±»å‹ï¼šè¿‡åº¦é˜²å¾¡æ€§é™çº§/ä¿å®ˆå›é€€
- æè¿°ï¼šä¸Šä¸‹æ–‡ç»„è£…å¼‚å¸¸è¢«ç›´æ¥åæ‰ï¼Œä»…æ³¨é‡Šè¯´æ˜ best-effortï¼Œæ— æ—¥å¿—ã€æ— å‘Šè­¦é€ä¼ ã€‚
- ä»£ç ç‰‡æ®µï¼š
```ts
try {
  const assembled = await assembleContextPrompt(...);
  if (assembled && assembled.prompt.trim().length > 0) {
    contextPrompt = assembled.prompt;
  }
} catch {
  // Context is best-effort ...
}
```
- é£é™©ï¼šçœŸå®æ•…éšœä¼šè¢«é™é»˜é™çº§ä¸ºæ— ä¸Šä¸‹æ–‡æ‰§è¡Œï¼Œè¾“å‡ºè´¨é‡æ¼‚ç§»ä¸”éš¾æ’æŸ¥ã€‚
- å»ºè®®ä¿®å¤ï¼šè®°å½•ç»“æ„åŒ– warningï¼ˆexecutionId/skillIdï¼‰ï¼Œå¹¶åœ¨ diagnostics æ ‡è®° `context_degraded`ã€‚
- ä¼˜å…ˆçº§ï¼šP1

### [A2-H-002] metadata è§£æå¤±è´¥å³æ¸…ç©ºå›å†™
- æ–‡ä»¶ï¼š`apps/desktop/renderer/src/features/kg/kgToGraph.ts`
- è¡Œå·/èŒƒå›´ï¼šL228-L243
- é—®é¢˜ç±»å‹ï¼šè¿‡åº¦ fallback é“¾
- æè¿°ï¼š`metadataJson` è§£æå¤±è´¥åç›´æ¥ `metadata = {}` å¹¶å›å†™ï¼Œå±äºå¤±è´¥å³æ¸…ç©ºå¼å›é€€ã€‚
- ä»£ç ç‰‡æ®µï¼š
```ts
try {
  metadata = JSON.parse(currentMetadataJson) as Record<string, unknown>;
} catch {
  metadata = {};
}
const ui = (metadata.ui as Record<string, unknown>) ?? {};
ui.position = position;
metadata.ui = ui;
return JSON.stringify(metadata);
```
- é£é™©ï¼šå¼‚å¸¸è¾“å…¥ä¸‹å¯èƒ½è¦†ç›–åŸ metadataï¼Œå½¢æˆéšæ€§æ•°æ®ä¸¢å¤±ã€‚
- å»ºè®®ä¿®å¤ï¼šè§£æå¤±è´¥æ—¶æ‹’ç»å†™å…¥å¹¶æ˜¾å¼æŠ¥é”™/æç¤ºï¼Œæˆ–ä¿ç•™åŸå§‹å€¼ã€‚
- ä¼˜å…ˆçº§ï¼šP1

### [A2-H-003] KG Panel å­˜åœ¨å¤šå±‚æ¸…ç©º fallback é“¾
- æ–‡ä»¶ï¼š`apps/desktop/renderer/src/features/kg/KnowledgeGraphPanel.tsx`
- è¡Œå·/èŒƒå›´ï¼šL50-L55, L63-L66
- é—®é¢˜ç±»å‹ï¼šè¿‡åº¦ fallback é“¾
- æè¿°ï¼šmetadata è§£æå¤±è´¥è¿”å› `{}`ï¼Œåç»­ç›´æ¥å†™ timelineï¼Œå½¢æˆå¤šå±‚â€œæ¸…ç©ºåå†å†™â€ã€‚
- ä»£ç ç‰‡æ®µï¼š
```ts
function parseMetadataJson(metadataJson: string): Record<string, unknown> {
  try { return JSON.parse(metadataJson) as Record<string, unknown>; }
  catch { return {}; }
}
const timeline = (metadata.timeline as Record<string, unknown>) ?? {};
timeline.order = order;
metadata.timeline = timeline;
```
- é£é™©ï¼šå¼‚å¸¸è¾“å…¥ä¸‹æŒç»­è¦†ç›–æ—§ metadataï¼Œå¯¼è‡´è¡¨é¢æˆåŠŸä½†æ•°æ®æ¼‚ç§»ã€‚
- å»ºè®®ä¿®å¤ï¼šç»Ÿä¸€ metadata è§£æç­–ç•¥ï¼ˆå¤±è´¥å³ fail-fast + è¯Šæ–­ï¼‰ã€‚
- ä¼˜å…ˆçº§ï¼šP1

### [A2-H-004] æŠ€èƒ½ç›®å½•è¯»å–å¤±è´¥ç»Ÿä¸€è¿”å›ç©ºæ•°ç»„
- æ–‡ä»¶ï¼š`apps/desktop/main/src/services/skills/skillLoader.ts`
- è¡Œå·/èŒƒå›´ï¼šL125-L135
- é—®é¢˜ç±»å‹ï¼šè¿‡åº¦é˜²å¾¡æ€§é™çº§/ä¿å®ˆå›é€€
- æè¿°ï¼šç›®å½•è¯»å–å¤±è´¥ç»Ÿä¸€å› `[]`ï¼Œæ— é”™è¯¯ä¸Šä¸‹æ–‡ã€‚
- ä»£ç ç‰‡æ®µï¼š
```ts
function listSubdirs(dirPath: string): string[] {
  try {
    const entries = fs.readdirSync(dirPath, { withFileTypes: true });
    ...
  } catch {
    return [];
  }
}
```
- é£é™©ï¼šæƒé™/è·¯å¾„é”™è¯¯è¡¨ç°ä¸ºâ€œæ²¡æœ‰æŠ€èƒ½â€ï¼Œå½¢æˆå¹½çµæ•…éšœå…¥å£ã€‚
- å»ºè®®ä¿®å¤ï¼šè¿”å›å¸¦é”™è¯¯ç çš„ç»“æœç»“æ„ï¼Œå¹¶è®°å½• `dirPath + errno`ã€‚
- ä¼˜å…ˆçº§ï¼šP1

## ğŸŸ¡ ä¸­å±é—®é¢˜ï¼ˆMediumï¼‰
### [A2-M-001] Context fetcher å¼‚å¸¸ç»†èŠ‚è¢«æŠ¹å¹³
- æ–‡ä»¶ï¼š`apps/desktop/main/src/services/context/fetchers/settingsFetcher.ts`
- è¡Œå·/èŒƒå›´ï¼šL82-L87
- é—®é¢˜ç±»å‹ï¼šè¿‡åº¦é˜²å¾¡æ€§é™çº§/ä¿å®ˆå›é€€
- æè¿°ï¼šå¤šå¤„ fetcher åœ¨å¼‚å¸¸æ—¶ç»Ÿä¸€å›ç©º chunks + warningï¼Œä½†ä¸ä¿ç•™åº•å±‚å¼‚å¸¸ç»†èŠ‚ã€‚
- ä»£ç ç‰‡æ®µï¼š
```ts
} catch {
  return { chunks: [], warnings: [KG_UNAVAILABLE_WARNING] };
}
```
- é£é™©ï¼šå®šä½æˆæœ¬é«˜ï¼Œå®¹æ˜“é•¿æœŸå¸¦ç—…é™çº§è¿è¡Œã€‚
- å»ºè®®ä¿®å¤ï¼šwarning ä¸­åŠ å…¥å¯å®¡è®¡é”™è¯¯æ‘˜è¦ IDã€‚
- ä¼˜å…ˆçº§ï¼šP2

### [A2-M-002] runId/executionId åŒå­—æ®µé•¿æœŸå¹¶å­˜
- æ–‡ä»¶ï¼š`apps/desktop/main/src/ipc/ai.ts`
- è¡Œå·/èŒƒå›´ï¼šL838
- é—®é¢˜ç±»å‹ï¼šé‡æ„å›é¿/åªå¢ä¸æ”¹ï¼ˆç–‘ä¼¼ï¼‰
- æè¿°ï¼š`executionId ?? runId ?? ""` åæ˜ è¡¥ä¸å¼å…¼å®¹å»¶ç»­ã€‚
- ä»£ç ç‰‡æ®µï¼š
```ts
const executionId = (payload.executionId ?? payload.runId ?? "").trim();
```
- é£é™©ï¼šåè®®è¯­ä¹‰æ¨¡ç³Šï¼Œè¯¯ç”¨åªåœ¨è¿è¡Œæ—¶æš´éœ²ã€‚
- å»ºè®®ä¿®å¤ï¼šè®¾å®šè¿ç§»çª—å£ï¼Œæ”¶æ•›å•ä¸€å­—æ®µå¹¶è¾“å‡ºå¼ƒç”¨å‘Šè­¦ã€‚
- ä¼˜å…ˆçº§ï¼šP2

### [A2-M-003] id/skillId åŒè½¨å…¼å®¹å †å 
- æ–‡ä»¶ï¼š`apps/desktop/main/src/ipc/skills.ts`
- è¡Œå·/èŒƒå›´ï¼šL129
- é—®é¢˜ç±»å‹ï¼šé‡æ„å›é¿/åªå¢ä¸æ”¹ï¼ˆç–‘ä¼¼ï¼‰
- æè¿°ï¼š`id ?? skillId ?? ""` åŒç±»å…¼å®¹å †å ã€‚
- ä»£ç ç‰‡æ®µï¼š
```ts
const id = payload.id ?? payload.skillId ?? "";
```
- é£é™©ï¼šæ¥å£å¥‘çº¦é•¿æœŸåŒè½¨ï¼Œåˆ†æ”¯å’Œæµ‹è¯•çŸ©é˜µè†¨èƒ€ã€‚
- å»ºè®®ä¿®å¤ï¼šç»Ÿä¸€è¯·æ±‚ schemaï¼Œå…¼å®¹æœŸæ‰“ç‚¹ç»Ÿè®¡æ—§å­—æ®µä½¿ç”¨ç‡ã€‚
- ä¼˜å…ˆçº§ï¼šP2

### [A2-M-004] Ping handler ä¸å¯è¾¾ catch åˆ†æ”¯
- æ–‡ä»¶ï¼š`apps/desktop/main/src/index.ts`
- è¡Œå·/èŒƒå›´ï¼šL175-L182
- é—®é¢˜ç±»å‹ï¼šå¹½çµ Bug/è¾¹ç•Œè¿‡åº¦å¤„ç†
- æè¿°ï¼š`app:system:ping` å†…éƒ¨ `try/catch` åŒ…è£¹çº¯å¸¸é‡è¿”å›ï¼Œcatch åˆ†æ”¯ç–‘ä¼¼æ°¸ä¸è§¦å‘ã€‚
- ä»£ç ç‰‡æ®µï¼š
```ts
try {
  return { ok: true, data: {} };
} catch {
  return { ok: false, error: { code: "INTERNAL", message: "Ping failed" } };
}
```
- é£é™©ï¼šæ— æ•ˆé˜²å¾¡åˆ†æ”¯å¢åŠ å™ªå£°ï¼Œæ©ç›–çœŸå®é”™è¯¯æ¨¡å‹ã€‚
- å»ºè®®ä¿®å¤ï¼šåˆ é™¤ä¸å¯è¾¾ catchï¼›å¦‚éœ€å®¹é”™åº”åŒ…è£¹çœŸå®å¯æŠ›é”™è¯­å¥ã€‚
- ä¼˜å…ˆçº§ï¼šP2

## ğŸ”µ ä½å±é—®é¢˜ï¼ˆLowï¼‰
### [A2-L-001] AppShell JSON è§£æå¤±è´¥åé™é»˜é»˜è®¤å€¼
- æ–‡ä»¶ï¼š`apps/desktop/renderer/src/components/layout/AppShell.tsx`
- è¡Œå·/èŒƒå›´ï¼šL72-L109
- é—®é¢˜ç±»å‹ï¼šè¿‡åº¦é˜²å¾¡æ€§é™çº§/ä¿å®ˆå›é€€
- æè¿°ï¼šæ–‡æ¡£ JSON è§£æå¤±è´¥ç›´æ¥å› `Untitled + ç©ºæ®µè½`ï¼Œæœªé™„å¸¦å¯è§‚æµ‹è¯Šæ–­ã€‚
- ä»£ç ç‰‡æ®µï¼š
```ts
try {
  const doc = JSON.parse(contentJson) ...
  ...
} catch {
  return { title: "Untitled", paragraphs: [], wordCount: 0 };
}
```
- é£é™©ï¼šUI æ˜¾ç¤ºæ­£å¸¸é»˜è®¤å€¼æ©ç›–æ•°æ®å¼‚å¸¸ï¼Œé—®é¢˜æ„ŸçŸ¥æ»åã€‚
- å»ºè®®ä¿®å¤ï¼šå¢åŠ ä¸€æ¬¡æ€§å‘Šè­¦å¹¶è®°å½•å¤±è´¥æ ·æœ¬ IDã€‚
- ä¼˜å…ˆçº§ï¼šP3

### [A2-L-002] contextRules éæ³•è¾“å…¥è¢«åå¹¶ä¸ºç©ºå¯¹è±¡
- æ–‡ä»¶ï¼š`apps/desktop/main/src/services/skills/skillService.ts`
- è¡Œå·/èŒƒå›´ï¼šL212-L225
- é—®é¢˜ç±»å‹ï¼šè¿‡åº¦ fallback é“¾ï¼ˆç–‘ä¼¼ï¼‰
- æè¿°ï¼š`contextRules` JSON éæ³•æˆ–ç±»å‹ä¸ç¬¦å‡å› `{}`ï¼Œè¯­ä¹‰è¢«åå¹¶ã€‚
- ä»£ç ç‰‡æ®µï¼š
```ts
try {
  const parsed: unknown = JSON.parse(raw);
  if (typeof parsed === "object" && parsed !== null && !Array.isArray(parsed)) {
    return parsed as Record<string, unknown>;
  }
  return {};
} catch {
  return {};
}
```
- é£é™©ï¼šè°ƒç”¨æ–¹è¯¯ä¼ é…ç½®æ—¶ç³»ç»Ÿé™é»˜é‡‡ç”¨ç©ºè§„åˆ™ï¼Œè¡Œä¸ºæ¼‚ç§»éš¾å¯Ÿè§‰ã€‚
- å»ºè®®ä¿®å¤ï¼šåŒºåˆ†éæ³• JSON ä¸ç©ºè§„åˆ™ï¼Œè¿”å›æ ¡éªŒé”™è¯¯æˆ– warningã€‚
- ä¼˜å…ˆçº§ï¼šP3

## æ¨¡å¼ç»Ÿè®¡
- è¿‡åº¦é˜²å¾¡æ€§é™çº§/ä¿å®ˆå›é€€ï¼š5
- é‡æ„å›é¿/åªå¢ä¸æ”¹ï¼š2
- å¹½çµ Bug/è¾¹ç•Œè¿‡åº¦å¤„ç†ï¼š1
- è¿‡åº¦ fallback é“¾ï¼š2
